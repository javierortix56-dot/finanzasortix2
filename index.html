<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuentas Javier y Mary</title>
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/wallet.png">
    <meta name="apple-mobile-web-app-title" content="Finanzas">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS MOBILE OPTIMIZED V11 --- */
        :root {
            --bg: #F0F4F8; --card: #FFFFFF; --border: #D1D9E6;
            --text-1: #101828; --text-2: #475467; --text-3: #98A2B3;
            --primary: #3B82F6; --success: #10B981; --danger: #EF4444; --warn: #F59E0B;
            --r-card: 14px; --r-in: 8px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-1); margin: 0; padding: 12px; font-size: 13px; }

        /* LAYOUT PRINCIPAL */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 15px; max-width: 600px; margin: 0 auto; }
        @media (min-width: 900px) { .grid-container { display: grid; grid-template-columns: 1fr 340px; align-items: start; flex-direction: unset; } }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--r-card); padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        
        /* TOP BAR */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: var(--card); padding: 8px 14px; border-radius: var(--r-card); border: 1px solid var(--border); }
        .app-title { display: flex; align-items: center; gap: 8px; color: var(--primary); font-weight: 700; font-size: 1.1em; }
        .month-nav { display: flex; align-items: center; gap: 2px; background: #F1F5F9; padding: 2px; border-radius: 8px; }
        .month-nav button { border: none; background: transparent; padding: 6px 10px; font-size: 14px; color: var(--text-2); }
        .month-display { position: relative; width: 85px; text-align: center; font-weight: 700; font-size: 11px; text-transform: uppercase; }
        #currentMonth { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; }

        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 12px; text-align: center; }
        .kpi-label { font-size: 9px; color: var(--text-3); font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .kpi-value { font-size: 15px; font-weight: 700; }
        .kpi-input { border: 1px solid var(--border); width: 100%; text-align: center; font-weight: 600; font-size: 12px; border-radius: 4px; padding: 2px; color: var(--text-2); }

        /* FORMULARIO COMPACTO (2 FILAS) */
        .form-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .form-col { flex: 1; }
        .form-col.small { flex: 0.6; }
        label { display: block; font-size: 9px; font-weight: 700; color: var(--text-3); text-transform: uppercase; margin-bottom: 3px; }
        input, select { width: 100%; height: 34px; padding: 0 8px; border: 1px solid var(--border); border-radius: var(--r-in); font-size: 13px; background: #FFF; }
        
        .check-btn { display: flex; align-items: center; justify-content: center; height: 34px; border: 1px solid var(--border); border-radius: var(--r-in); background: #FFF; gap: 6px; font-size: 11px; font-weight: 600; color: var(--text-2); }
        .check-btn input { width: auto; height: auto; margin: 0; }
        
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; border-radius: var(--r-in); font-weight: 600; height: 38px; font-size: 13px; margin-top: 4px; }
        .btn-mini { background: #fee2e2; color: #DC2626; border: none; width: 20px; border-radius: 4px; margin-left: 4px; font-size: 10px; }

        /* TABLA Y LISTA */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 10px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; background: #F8FAFC; padding: 6px 10px; color: var(--text-3); font-size: 9px; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 6px 10px; border-bottom: 1px solid var(--border); font-size: 12px; white-space: nowrap; height: 32px; }
        .tag { padding: 2px 6px; border-radius: 99px; font-size: 10px; font-weight: 600; background: #F1F5F9; color: var(--text-2); }
        
        /* GRÁFICO */
        .chart-container { position: relative; height: 180px; width: 100%; margin-top: 5px; }

        /* BACKUP SECTION */
        .tools { display: flex; gap: 8px; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; }
        .btn-sec { flex: 1; background: #FFF; border: 1px solid var(--border); padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 600; color: var(--text-2); }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="app-title"><i class="fas fa-wallet"></i> <span>Javier & Mary</span></div>
    <div class="month-nav">
        <button onclick="chMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="month-display">
            <span id="monthLabel">DIC 2025</span>
            <input type="month" id="currentMonth" onchange="load()">
        </div>
        <button onclick="chMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div class="grid-container">
    
    <div class="sidebar">
        
        <div class="kpi-row">
            <div class="kpi-card" style="border-bottom: 3px solid var(--primary)">
                <span class="kpi-label">Dólar</span>
                <input type="number" id="manualDolar" class="kpi-input" value="1200" onchange="saveDolar()">
            </div>
            <div class="kpi-card" style="border-bottom: 3px solid var(--success)">
                <span class="kpi-label">Balance</span>
                <div class="kpi-value" id="val-bal">$0</div>
            </div>
            <div class="kpi-card" style="border-bottom: 3px solid var(--warn)">
                <span class="kpi-label">Ahorro USD</span>
                <div class="kpi-value" id="val-usd" style="color:var(--warn)">$0</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 10px 0; font-size:13px; color:var(--text-2);">Nuevo Registro</h3>
            <form id="form">
                <div class="form-row">
                    <div class="form-col"><input type="date" id="date" required></div>
                    <div class="form-col small">
                        <label class="check-btn"><input type="checkbox" id="executed" checked> Pagado</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col small">
                        <select id="type" onchange="upCat()">
                            <option value="expense">Egreso</option>
                            <option value="income">Ingreso</option>
                        </select>
                    </div>
                    <div class="form-col"><input type="number" id="amount" placeholder="$ Monto" required step="0.01"></div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div style="display:flex"><select id="category" onchange="upCon()"></select></div>
                        <input id="customCat" placeholder="Nueva Cat..." style="display:none; margin-top:4px">
                    </div>
                    <div class="form-col">
                        <div style="display:flex"><select id="conceptSelect" onchange="hCon()"></select></div>
                        <input id="customCon" placeholder="Nuevo Con..." style="display:none; margin-top:4px">
                    </div>
                </div>

                <button type="submit" id="btn-submit" class="btn-main">Guardar</button>
                <button type="button" id="btn-cancel" onclick="cancelEdit()" style="display:none; margin-top:5px; background:#fff; color:#666; border:1px solid #ddd;" class="btn-main">Cancelar Edición</button>
            </form>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="margin:0; font-size:13px; color:var(--text-2)">Distribución</h3>
            </div>
            <div class="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>

    <div class="main-col">
        <div class="card">
            <h3 style="margin:0; font-size:13px; color:var(--text-2)">Movimientos del Mes</h3>
            <div class="table-wrap">
                <table>
                    <thead><tr><th width="30"></th><th>Fecha</th><th>Cat</th><th>Concepto</th><th style="text-align:right">$$$</th><th style="text-align:center">Act</th></tr></thead>
                    <tbody id="list"></tbody>
                </table>
            </div>
            
            <div class="tools">
                <button class="btn-sec" onclick="dl()">⬇ Backup</button>
                <input type="file" id="ul" style="display:none" onchange="ul(this)">
                <button class="btn-sec" onclick="document.getElementById('ul').click()">⬆ Cargar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATOS Y VARIABLES ---
    const def = { cats: { income: ["Ingresos"], expense: ["Esenciales", "Deudas", "Varios", "Ahorro"] }, cons: { "Ingresos":["Sueldo"], "Esenciales":["Alquiler","Super"], "Deudas":["Tarjeta"], "Varios":["Salidas"], "Ahorro":["USD"] } };
    // Usamos nombres originales para compatibilidad con backup
    let appData = JSON.parse(localStorage.getItem('appData_v8')) || def;
    let transactions = JSON.parse(localStorage.getItem('transactions_v4')) || [];
    let editingId = null;
    // Paleta de colores vivos para el gráfico
    const palette = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#F97316', '#06B6D4', '#EC4899'];

    // --- INICIALIZACIÓN ---
    window.onload = () => {
        const t = new Date();
        document.getElementById('date').value = t.toISOString().split('T')[0];
        document.getElementById('currentMonth').value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
        upCat(); load();
    };

    // --- LÓGICA DE FORMULARIO ---
    function upCat() {
        const t = document.getElementById('type').value, s = document.getElementById('category'); s.innerHTML='';
        let c = t==='income'?appData.cats.income:appData.cats.expense;
        [...c].sort().forEach(x=>{let o=document.createElement('option');o.value=x;o.text=x;s.add(o)});
        s.add(new Option('Otro','Otro')); upCon();
    }
    function upCon() {
        const c=document.getElementById('category').value, s=document.getElementById('conceptSelect'); s.innerHTML='';
        if(c==='Otro') document.getElementById('customCat').style.display='block';
        else {
            document.getElementById('customCat').style.display='none';
            (appData.cons[c]||[]).sort().forEach(x=>s.add(new Option(x,x)));
            s.add(new Option('Otro','Otro'));
        }
        hCon();
    }
    function hCon() { document.getElementById('customCon').style.display = document.getElementById('conceptSelect').value==='Otro'?'block':'none'; }

    // --- GUARDAR ---
    document.getElementById('form').onsubmit = (e) => {
        e.preventDefault();
        const type=document.getElementById('type').value, amt=document.getElementById('amount').value, date=document.getElementById('date').value;
        let cat=document.getElementById('category').value, con=document.getElementById('conceptSelect').value;
        
        if(cat==='Otro'){ cat=document.getElementById('customCat').value; if(type==='income'){if(!appData.cats.income.includes(cat))appData.cats.income.push(cat)}else{if(!appData.cats.expense.includes(cat))appData.cats.expense.push(cat)} appData.cons[cat]=[]; }
        if(con==='Otro'){ con=document.getElementById('customCon').value; if(!appData.cons[cat].includes(con))appData.cons[cat].push(con); }
        
        localStorage.setItem('appData_v8',JSON.stringify(appData));
        const tr = { id: editingId||Date.now(), date: date, monthKey: date.slice(0,7), text: con, category: cat, amount: type==='expense'?-Math.abs(amt):Math.abs(amt), executed: document.getElementById('executed').checked };
        
        if(editingId){ transactions[transactions.findIndex(x=>x.id===editingId)]=tr; cancelEdit(); } else { transactions.push(tr); }
        localStorage.setItem('transactions_v4',JSON.stringify(transactions));
        load();
    };

    // --- RENDERIZADO ---
    function load() {
        const mk = document.getElementById('currentMonth').value;
        const d = new Date(mk+'-02');
        document.getElementById('monthLabel').innerText = d.toLocaleString('es',{month:'short',year:'numeric'}).toUpperCase();
        
        let f = transactions.filter(t=>t.monthKey===mk).sort((a,b)=>new Date(a.date)-new Date(b.date));
        
        // Tabla
        const l = document.getElementById('list'); l.innerHTML='';
        f.forEach(t => {
            let row = l.insertRow();
            row.innerHTML = `<td style="text-align:center"><i class="fas ${t.executed?'fa-check-circle':'fa-clock'}" style="color:${t.executed?'var(--success)':'#CBD5E1'};cursor:pointer" onclick="tog(${t.id})"></i></td>
            <td>${t.date.slice(8,10)}</td>
            <td><span class="tag">${t.category.slice(0,10)}</span></td>
            <td>${t.text}</td>
            <td style="text-align:right;font-weight:700;color:${t.amount<0?'var(--text-1)':'var(--success)'}">$${Math.abs(t.amount).toLocaleString()}</td>
            <td style="text-align:center"><i class="fas fa-pen" onclick="ed(${t.id})" style="color:var(--warn);cursor:pointer;font-size:12px;margin-right:8px"></i><i class="fas fa-trash" onclick="del(${t.id})" style="color:var(--danger);cursor:pointer;font-size:12px"></i></td>`;
        });

        // Totales
        const inc = f.reduce((s,t)=>t.amount>0?s+t.amount:s,0);
        const exp = f.reduce((s,t)=>t.amount<0?s+Math.abs(t.amount):s,0);
        document.getElementById('val-bal').innerText = `$${(inc-exp).toLocaleString()}`;
        const dol = parseFloat(document.getElementById('manualDolar').value)||1200;
        document.getElementById('val-usd').innerText = `US$ ${((inc-exp)/dol).toFixed(2)}`;

        // Chart Multicolor
        drawChart(f, inc, exp);
    }

    let myChart = null;
    function drawChart(f, inc, exp) {
        const ctx = document.getElementById('chart').getContext('2d');
        const exps = f.filter(t=>t.amount<0);
        const grp = {}; exps.forEach(t=>{ grp[t.category] = (grp[t.category]||0)+Math.abs(t.amount) });
        
        let lbl = Object.keys(grp), val = Object.values(grp);
        const bal = inc - exp;
        if(bal > 0) { lbl.push("Saldo"); val.push(bal); }

        // Asignación de colores vivos
        const bg = lbl.map((l,i) => l==='Saldo' ? '#E2E8F0' : palette[i % palette.length]);

        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: lbl, datasets: [{ data: val, backgroundColor: bg, borderWidth: 0 }] },
            options: { 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } 
                } 
            }
        });
    }

    // --- UTILIDADES ---
    function chMonth(s) { const i=document.getElementById('currentMonth'), [y,m]=i.value.split('-').map(Number); const d=new Date(y,m-1+s,1); i.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; load(); }
    function tog(id) { const t=transactions.find(x=>x.id===id); t.executed=!t.executed; save(); load(); }
    function del(id) { if(confirm('¿Borrar?')){ transactions=transactions.filter(x=>x.id!==id); save(); load(); } }
    function ed(id) { 
        const t=transactions.find(x=>x.id===id); editingId=id;
        document.getElementById('date').value=t.date; document.getElementById('amount').value=Math.abs(t.amount);
        document.getElementById('type').value=t.amount>0?'income':'expense'; upCat();
        document.getElementById('category').value=t.category; upCon();
        document.getElementById('conceptSelect').value=t.text;
        document.getElementById('btn-submit').innerText='Actualizar'; document.getElementById('btn-cancel').style.display='block';
        window.scrollTo({top:0, behavior:'smooth'});
    }
    function cancelEdit(){ editingId=null; document.getElementById('form').reset(); document.getElementById('btn-submit').innerText='Guardar'; document.getElementById('btn-cancel').style.display='none'; }
    function save(){ localStorage.setItem('transactions_v4',JSON.stringify(transactions)); }
    function saveDolar(){ load(); }
    function dl(){ const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({transactions,appData})); a.download="backup.json"; a.click(); }
    function ul(e){ const r=new FileReader(); r.onload=ev=>{ const d=JSON.parse(ev.target.result); transactions=d.transactions; appData=d.appData; save(); localStorage.setItem('appData_v8',JSON.stringify(appData)); load(); }; r.readAsText(e.files[0]); }
</script>
</body>
</html>
