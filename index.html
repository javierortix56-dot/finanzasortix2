<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>J&M V33.2 Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-app: #F8FAFC; --surface: #FFFFFF;
            --text-dark: #0F172A; --text-gray: #64748B;
            --inc-color: #10B981; --inc-bg: #ECFDF5;
            --exp-color: #EF4444; --exp-bg: #FEF2F2;
            --primary: #2563EB; --border: #E2E8F0;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-app); 
            margin: 0; color: var(--text-dark); padding-bottom: 100px;
        }

        /* --- HEADER --- */
        .top-bar {
            background: var(--surface); height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 50;
        }
        .brand { font-weight: 900; color: var(--primary); font-size: 18px; }
        
        .date-ctrl { 
            display: flex; align-items: center; background: #F1F5F9; 
            border-radius: 8px; padding: 2px; border: 1px solid var(--border);
            position: relative; /* Fix z-index issues */
        }
        .btn-arrow { 
            background: transparent; border: none; width: 36px; height: 32px;
            cursor: pointer; color: var(--text-dark); font-size: 14px; display: flex; align-items: center; justify-content: center;
            z-index: 10; /* Ensure arrows are clickable */
        }
        .btn-arrow:active { background: #CBD5E1; border-radius: 6px; }
        
        .date-display { 
            font-size: 12px; font-weight: 700; text-transform: uppercase; 
            min-width: 90px; text-align: center; position: relative;
        }

        /* --- BALANCE --- */
        .kpi-wrapper { padding: 15px 15px 5px 15px; }
        .kpi-card {
            background: var(--surface); padding: 20px; border-radius: 16px;
            border: 1px solid var(--border); text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-gray); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .kpi-val { font-size: 32px; font-weight: 800; letter-spacing: -1px; color: var(--text-dark); line-height: 1.1; }
        
        .kpi-sub { 
            margin-top: 10px; padding-top: 10px; border-top: 1px solid #F1F5F9;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            font-size: 13px; font-weight: 600; color: var(--text-gray);
        }
        .usd-edit { 
            background: #F1F5F9; border: 1px solid var(--border); width: 60px; text-align: right; 
            border-radius: 4px; font-size: 12px; padding: 4px; color: var(--text-dark); font-weight: 700;
        }

        /* --- COPY BTN ZONE --- */
        .copy-zone {
            padding: 15px; margin: 0 15px 10px 15px; display: none; 
            background: white; border-radius: 12px; border: 1px dashed var(--border);
        }
        .copy-controls { display: flex; gap: 8px; margin-top: 8px; }
        .btn-copy-month {
            flex: 1; background: var(--text-dark); color: white;
            border: none; padding: 0 12px; border-radius: 8px;
            font-weight: 700; font-size: 13px; cursor: pointer;
            height: 40px;
        }

        /* --- T-VIEW --- */
        .t-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            padding: 15px; align-items: start;
        }
        .t-col { 
            background: var(--surface); border-radius: 12px; 
            border: 1px solid var(--border); overflow: hidden;
            min-height: 100px;
        }
        .col-header { 
            padding: 8px; text-align: center; font-size: 11px; font-weight: 800; 
            text-transform: uppercase; color: white; letter-spacing: 0.5px;
        }
        .bg-inc { background: var(--inc-color); }
        .bg-exp { background: var(--exp-color); }
        .col-total { display: block; background: rgba(0,0,0,0.1); margin-top: 2px; border-radius: 4px; padding: 2px; }
        
        .t-list { padding: 0; }
        .row-item {
            background: white; padding: 10px 8px;
            border-bottom: 1px solid #F1F5F9; cursor: pointer;
        }
        .row-main { font-size: 13px; font-weight: 700; color: var(--text-dark); margin-bottom: 2px; line-height: 1.2; }
        .row-sub { display: flex; justify-content: space-between; align-items: center; }
        .row-cat { font-size: 9px; font-weight: 600; color: var(--text-gray); background: #F8FAFC; padding: 2px 4px; border-radius: 4px; text-transform: uppercase; }
        .row-date { font-size: 10px; font-weight: 600; color: #94A3B8; }
        .row-amt { font-size: 13px; font-weight: 800; }
        .c-inc { color: var(--inc-color); } .c-exp { color: var(--exp-color); }

        .alert-dot { display: inline-block; width: 6px; height: 6px; background: #F59E0B; border-radius: 50%; margin-left: 4px; vertical-align: middle; }

        /* --- CHART & TOOLS --- */
        .section-header { 
            padding: 0 20px; margin-top: 25px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .sec-title { font-size: 14px; font-weight: 800; color: var(--text-dark); }
        .btn-reset-chart { font-size: 11px; color: var(--primary); font-weight: 700; border: none; background: none; cursor: pointer; display: none; }
        
        .chart-box { 
            background: var(--surface); margin: 0 15px; padding: 15px; 
            border-radius: 16px; border: 1px solid var(--border); height: 320px; position: relative;
        }

        .action-btns { padding: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-big {
            flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
            background: white; color: var(--text-dark); font-weight: 700; font-size: 12px;
            display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
            min-width: 45%;
        }
        
        .btn-danger-zone {
            width: 100%; margin-top: 20px; text-align: center;
        }
        .btn-clear {
            background: transparent; border: 1px solid #FECACA; color: #EF4444;
            padding: 10px 20px; border-radius: 8px; font-size: 11px; font-weight: 700;
            cursor: pointer;
        }

        /* --- FAB & FORM --- */
        .fab { 
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; 
            background: var(--text-dark); color: white; border-radius: 50%; border:none; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 24px; cursor: pointer; z-index: 40; 
        }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; backdrop-filter: blur(3px); }
        .sheet { 
            position: fixed; bottom: 0; width: 100%; background: white; z-index: 100;
            border-radius: 20px 20px 0 0; transform: translateY(100%); transition: 0.3s;
            padding: 25px 20px; max-height: 90vh; overflow-y: auto;
        }
        .sheet.open { transform: translateY(0); }

        .inp-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .inp-grp { flex: 1; }
        .lbl { font-size: 11px; font-weight: 700; color: var(--text-gray); display: block; margin-bottom: 5px; text-transform: uppercase; }
        .inp { width: 100%; height: 45px; border: 1px solid var(--border); border-radius: 10px; padding: 0 12px; background: #F8FAFC; font-size: 15px; }
        
        .btn-save { width: 100%; height: 50px; background: var(--text-dark); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; margin-top: 15px; }
        .sw-container { display: flex; background: #F1F5F9; padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .sw-item { flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 600; color: var(--text-gray); border-radius: 8px; cursor: pointer; }
        .sw-item.active.inc { background: var(--inc-color); color: white; }
        .sw-item.active.exp { background: var(--exp-color); color: white; }

    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>

<header class="top-bar">
    <div class="brand">J&M</div>
    <div class="date-ctrl">
        <button class="btn-arrow" type="button" onclick="navMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="date-display">
            <span id="monthTxt">...</span>
            <input type="month" id="dateInput" onchange="loadData()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </div>
        <button class="btn-arrow" type="button" onclick="navMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</header>

<div class="kpi-wrapper">
    <div class="kpi-card">
        <div class="kpi-label">Balance Neto</div>
        <div class="kpi-val" id="kpiBal">$0</div>
        <div class="kpi-sub">
            <span>USD <span id="kpiUsd" style="color:var(--text-dark); font-weight:800;">0.00</span></span>
            <span style="color:#E2E8F0">|</span>
            <span>TC: <input type="number" id="usdRate" value="1200" class="usd-edit" onchange="loadData()"></span>
        </div>
    </div>
</div>

<div class="copy-zone" id="copyZone">
    <div style="font-size:12px; font-weight:600; color:var(--text-gray);">Mes vacío. Importar desde:</div>
    <div class="copy-controls">
        <input type="month" id="copySourcePicker" class="inp" style="height:40px;">
        <button class="btn-copy-month" onclick="copyFromSelected()">
            <i class="fas fa-copy"></i> COPIAR
        </button>
    </div>
</div>

<div class="t-grid">
    <div class="t-col">
        <div class="col-header bg-inc">Ingresos<br><span class="col-total" id="sum-inc">$0</span></div>
        <div class="t-list" id="list-inc"></div>
    </div>
    <div class="t-col">
        <div class="col-header bg-exp">Egresos<br><span class="col-total" id="sum-exp">$0</span></div>
        <div class="t-list" id="list-exp"></div>
    </div>
</div>

<div class="section-header">
    <span class="sec-title">Distribución</span>
    <button id="chartReset" class="btn-reset-chart" onclick="resetChart()">
        <i class="fas fa-arrow-left"></i> VOLVER A CATEGORÍAS
    </button>
</div>
<div class="chart-box">
    <canvas id="myChart"></canvas>
    <div id="chartCenterText" style="position:absolute; top:40%; left:50%; transform:translate(-50%, -50%); font-size:10px; color:#64748B; pointer-events:none; font-weight:600; text-align:center;">
        Toca para<br>detalle
    </div>
</div>

<div class="action-btns">
    <button class="btn-big" onclick="backup()"><i class="fas fa-download"></i> Backup</button>
    <button class="btn-big" onclick="document.getElementById('fileIn').click()"><i class="fas fa-upload"></i> Restaurar</button>
    <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
    
    <div class="btn-danger-zone">
        <button class="btn-clear" onclick="clearCurrentMonth()">⚠️ Limpiar Mes Actual</button>
    </div>
</div>

<button class="fab" onclick="openSheet()"><i class="fas fa-plus"></i></button>

<div class="sheet" id="sheet">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <span style="font-size:18px; font-weight:800;" id="formTitle">Nuevo</span>
        <span onclick="closeSheet()" style="font-size:20px; color:#94A3B8;"><i class="fas fa-times"></i></span>
    </div>

    <form id="txForm">
        <div class="sw-container">
            <div class="sw-item" id="sw-exp" onclick="setType('exp')">Gasto</div>
            <div class="sw-item" id="sw-inc" onclick="setType('inc')">Ingreso</div>
        </div>
        <input type="hidden" id="fType" value="exp">

        <div class="inp-row">
            <div class="inp-grp">
                <label class="lbl">Monto</label>
                <input type="number" id="fAmount" class="inp" placeholder="0.00" step="0.01" required>
            </div>
            <div class="inp-grp">
                <label class="lbl">Fecha</label>
                <input type="date" id="fDate" class="inp" required>
            </div>
        </div>

        <div class="inp-grp" style="margin-bottom:15px;">
            <label class="lbl">Categoría</label>
            <select id="fCat" class="inp" onchange="renderConcepts()" required></select>
        </div>

        <div class="inp-grp" style="margin-bottom:15px;">
            <label class="lbl">Concepto</label>
            <select id="fConcept" class="inp" onchange="checkNewConcept()" required></select>
            <input type="text" id="fConceptCustom" class="inp" style="margin-top:10px; display:none;" placeholder="Nombre...">
        </div>

        <div style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="fExec" checked style="width:20px; height:20px;">
            <label for="fExec" style="font-weight:600; font-size:13px;">Consolidado (Pagado/Cobrado)</label>
        </div>

        <button type="submit" id="btnSave" class="btn-save">GUARDAR</button>
        <button type="button" id="btnDel" onclick="del(editId)" style="width:100%; color:#EF4444; background:none; border:none; padding:15px; font-weight:700; display:none;">Eliminar</button>
    </form>
</div>

<script>
    const defData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Ventas','Varios'] }, concepts: { "Esenciales": ["Alquiler", "Luz/Gas", "Supermercado"], "Deudas": ["Tarjeta Visa"], "Sueldo": ["Javier", "Mary"] } };
    let data = JSON.parse(localStorage.getItem('finData_v16')) || defData;
    let editId = null, chartInstance = null, currentTxs = [], currentChartFilter = null;

    window.onload = () => {
        const d = new Date();
        // Forzar siempre al mes actual al cargar
        const currentYM = d.toISOString().slice(0, 7);
        document.getElementById('dateInput').value = currentYM;
        
        // Prepara la fecha del formulario de nuevo ingreso
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        
        // Prepara el "source picker" al mes anterior por defecto
        const prevM = new Date(d.getFullYear(), d.getMonth() - 1, 1);
        document.getElementById('copySourcePicker').value = prevM.toISOString().slice(0, 7);

        if(localStorage.getItem('usdRate')) document.getElementById('usdRate').value = localStorage.getItem('usdRate');
        loadData();
    };

    function openSheet() { if(!editId) resetForm(); document.getElementById('sheet').classList.add('open'); document.getElementById('overlay').style.display='block'; }
    function closeSheet() { document.getElementById('sheet').classList.remove('open'); document.getElementById('overlay').style.display='none'; setTimeout(resetForm,300); }
    
    // --- NAVEGACION CORREGIDA ---
    function navMonth(n) { 
        const i = document.getElementById('dateInput'); 
        let [y, m] = i.value.split('-'); 
        
        // Crear fecha segura usando valores enteros
        const current = new Date(parseInt(y), parseInt(m)-1, 1);
        // Sumar/Restar meses
        current.setMonth(current.getMonth() + n);
        
        const newY = current.getFullYear();
        const newM = String(current.getMonth() + 1).padStart(2, '0');
        
        // Asignar y cargar
        i.value = `${newY}-${newM}`;
        loadData(); 
    }

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('monthTxt').innerText = `${months[parseInt(m)-1]} ${y}`;
        
        currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym)).sort((a,b) => a.date.localeCompare(b.date));
        
        // Mostrar zona de copiado si el mes está vacío
        const copyZone = document.getElementById('copyZone');
        if(currentTxs.length === 0) {
            copyZone.style.display = 'block';
            // Poner por defecto en el picker el mes inmediatamente anterior al actual visible
            const visibleDate = new Date(parseInt(y), parseInt(m)-1, 1);
            const prev = new Date(visibleDate.getFullYear(), visibleDate.getMonth()-1, 1);
            // Solo actualizamos si el usuario no ha tocado nada (opcional), aqui lo fuerzo para comodidad
            document.getElementById('copySourcePicker').value = prev.toISOString().slice(0,7);
        } else {
            copyZone.style.display = 'none';
        }
        
        renderLists(currentTxs);
        resetChart();
        renderCats();
        localStorage.setItem('usdRate', document.getElementById('usdRate').value);
    }

    // --- NUEVA FUNCION DE COPIADO SELECCIONABLE ---
    function copyFromSelected() {
        const targetYM = document.getElementById('dateInput').value; // Destino
        const sourceYM = document.getElementById('copySourcePicker').value; // Origen
        
        if(!sourceYM) { alert('Selecciona un mes de origen'); return; }
        if(sourceYM === targetYM) { alert('No puedes copiar el mismo mes sobre sí mismo'); return; }

        const sourceTxs = data.txs.filter(t => t.date.startsWith(sourceYM));
        
        if(sourceTxs.length === 0) {
            alert('El mes seleccionado (' + sourceYM + ') no tiene movimientos.');
            return;
        }
        
        if(!confirm(`Copiar ${sourceTxs.length} movimientos de ${sourceYM} a este mes?`)) return;

        const [tY, tM] = targetYM.split('-').map(Number); // Target Year, Month (1-12)

        sourceTxs.forEach(t => {
            const oldDay = parseInt(t.date.split('-')[2]);
            // Logica para evitar overflow de dias (ej 31 feb)
            let newDateObj = new Date(tY, tM - 1, oldDay);
            if (newDateObj.getMonth() !== tM - 1) {
                newDateObj = new Date(tY, tM, 0); // Ultimo dia del mes
            }
            
            const newTx = {
                ...t,
                id: Date.now() + Math.random(),
                date: newDateObj.toISOString().split('T')[0],
                exec: false // Copia siempre como pendiente
            };
            data.txs.push(newTx);
        });

        save();
        loadData();
    }

    // --- LIMPIAR MES ACTUAL (Boton oculto) ---
    function clearCurrentMonth() {
        const ym = document.getElementById('dateInput').value;
        if(!confirm(`⚠️ PELIGRO ⚠️\n\nEstás a punto de borrar TODOS los movimientos de: ${ym}.\n\n¿Estás seguro?`)) return;
        
        // Filtramos para quedarnos con TODO lo que NO sea de este mes
        data.txs = data.txs.filter(t => !t.date.startsWith(ym));
        save();
        loadData();
        alert('Mes limpiado.');
    }

    function renderLists(txs) {
        const lInc = document.getElementById('list-inc'), lExp = document.getElementById('list-exp');
        lInc.innerHTML = ''; lExp.innerHTML = '';
        let tInc=0, tExp=0; const today = new Date().toISOString().split('T')[0];

        txs.forEach(t => {
            const isInc = t.type === 'inc';
            const amt = Math.abs(t.amount);
            if(isInc) tInc += amt; else tExp += amt;

            let alertHTML = '';
            if(!t.exec && !isInc) {
                const diff = (new Date(t.date) - new Date(today)) / (86400000);
                if(diff <= 5) alertHTML = `<div class="alert-dot"></div>`;
            }
            const opacityStyle = !t.exec ? 'opacity:0.7;' : '';

            const div = document.createElement('div');
            div.className = 'row-item';
            div.style = opacityStyle;
            div.onclick = () => edit(t.id);
            div.innerHTML = `
                <div class="row-main">${t.desc} ${alertHTML}</div>
                <div class="row-sub">
                    <span class="row-cat">${t.cat}</span>
                    <span class="row-date">${t.date.split('-')[2]}</span>
                    <span class="row-amt ${isInc?'c-inc':'c-exp'}">${isInc?'+':''}$${Math.floor(amt).toLocaleString()}</span>
                </div>
            `;
            (isInc ? lInc : lExp).appendChild(div);
        });

        document.getElementById('sum-inc').innerText = `$${tInc.toLocaleString()}`;
        document.getElementById('sum-exp').innerText = `$${tExp.toLocaleString()}`;
        const bal = tInc - tExp;
        const balEl = document.getElementById('kpiBal');
        balEl.innerText = `$${bal.toLocaleString()}`;
        balEl.style.color = bal >= 0 ? '#10B981' : '#EF4444';

        const rate = parseFloat(document.getElementById('usdRate').value) || 1;
        document.getElementById('kpiUsd').innerText = (bal/rate).toFixed(2);
    }

    function resetChart() { renderChart(currentTxs, null); }

    function renderChart(txs, filterCat) {
        const ctx = document.getElementById('myChart'); 
        if(chartInstance) chartInstance.destroy();
        
        currentChartFilter = filterCat;
        const btnReset = document.getElementById('chartReset');
        const centerTxt = document.getElementById('chartCenterText');

        let exps = txs.filter(t => t.type === 'exp');
        let map = {};

        if (!filterCat) {
            btnReset.style.display = 'none';
            centerTxt.innerHTML = "Toca para<br>detalle";
            map = exps.reduce((a,t)=>{ a[t.cat]=(a[t.cat]||0)+t.amount; return a; }, {});
        } else {
            btnReset.style.display = 'block';
            centerTxt.innerText = filterCat;
            map = exps.filter(t => t.cat === filterCat).reduce((a,t)=>{ a[t.desc]=(a[t.desc]||0)+t.amount; return a; }, {});
        }

        const labels = Object.keys(map);
        const values = Object.values(map);

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { 
                labels: labels, 
                datasets: [{ 
                    data: values, 
                    backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1'],
                    borderWidth: 2, borderColor: '#ffffff'
                }] 
            },
            options: { 
                responsive:true, maintainAspectRatio:false, cutout:'60%',
                plugins: { 
                    legend: { 
                        display: true, 
                        position: 'bottom',
                        labels: {
                            boxWidth: 10,
                            font: { size: 10, family: 'Inter' },
                            padding: 15,
                            color: '#64748B'
                        }
                    } 
                },
                onClick: (e, elements) => {
                    if (elements.length > 0 && !filterCat) {
                        const i = elements[0].index;
                        renderChart(txs, labels[i]);
                    }
                }
            }
        });
    }

    function setType(t) {
        document.getElementById('fType').value = t;
        document.getElementById('sw-inc').className = `sw-item ${t=='inc'?'active inc':''}`;
        document.getElementById('sw-exp').className = `sw-item ${t=='exp'?'active exp':''}`;
        renderCats();
    }
    
    function renderCats() {
        const t = document.getElementById('fType').value;
        const s = document.getElementById('fCat'); s.innerHTML='';
        (data.cats[t]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Crear...','new'));
        renderConcepts();
    }
    
    function renderConcepts() {
        const cVal = document.getElementById('fCat').value;
        if(cVal==='new'){ 
            const n=prompt('Nueva Categoría:'); 
            if(n){ data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; save(); renderCats(); document.getElementById('fCat').value=n; } 
            else { renderCats(); return; }
        }
        const s = document.getElementById('fConcept'); s.innerHTML='';
        (data.concepts[cVal]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Nuevo...','new_c'));
        checkNewConcept();
    }
    
    function checkNewConcept() {
        const isNew = document.getElementById('fConcept').value==='new_c';
        document.getElementById('fConceptCustom').style.display=isNew?'block':'none';
    }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value;
        let desc = document.getElementById('fConcept').value;
        if(desc==='new_c') {
            desc=document.getElementById('fConceptCustom').value;
            if(!desc) return;
            if(!data.concepts[cat]) data.concepts[cat]=[];
            data.concepts[cat].push(desc);
        }
        const tx = { id:editId||Date.now(), date:document.getElementById('fDate').value, amount:parseFloat(document.getElementById('fAmount').value), type:document.getElementById('fType').value, cat, desc, exec:document.getElementById('fExec').checked };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i!==-1) data.txs[i]=tx; } else data.txs.push(tx);
        save(); closeSheet(); loadData();
    }

    function edit(id) {
        const t = data.txs.find(x=>x.id==id); if(!t)return;
        editId=id; document.getElementById('formTitle').innerText='Editar';
        document.getElementById('fDate').value=t.date; document.getElementById('fAmount').value=Math.abs(t.amount);
        document.getElementById('fExec').checked=t.exec;
        setType(t.type); document.getElementById('fCat').value=t.cat; renderConcepts();
        
        const s=document.getElementById('fConcept');
        let has=false; for(let i=0;i<s.options.length;i++) if(s.options[i].value==t.desc) has=true;
        if(!has) s.add(new Option(t.desc,t.desc),0); s.value=t.desc;
        
        checkNewConcept(); document.getElementById('btnDel').style.display='block'; document.getElementById('btnSave').innerText='ACTUALIZAR';
        document.getElementById('sheet').classList.add('open'); document.getElementById('overlay').style.display='block';
    }

    function resetForm() { 
        editId=null; document.getElementById('txForm').reset(); 
        document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; 
        document.getElementById('formTitle').innerText='Nuevo'; 
        document.getElementById('btnDel').style.display='none'; 
        document.getElementById('fConceptCustom').style.display='none'; 
        document.getElementById('btnSave').innerText='GUARDAR'; 
        setType('exp'); 
    }
    
    function del(id) { if(confirm('¿Borrar?')) { data.txs=data.txs.filter(x=>x.id!=id); save(); closeSheet(); loadData(); } }
    function save() { localStorage.setItem('finData_v16', JSON.stringify(data)); }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download=`JM_Backup.json`; a.click(); }
    function restoreSmart(i) { const r=new FileReader(); r.onload=e=>{ try{data=JSON.parse(e.target.result); save(); location.reload();}catch(x){alert('Archivo incorrecto');} }; r.readAsText(i.files[0]); }
</script>
</body>
</html>
