<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J&M Finance Pro | V24</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-app: #F8FAFC; --surface: #FFFFFF; --border: #E2E8F0;
            --text-1: #0F172A; --text-2: #475569; --text-3: #94A3B8;
            --primary: #2563EB; --primary-hover: #1D4ED8;
            --success: #16A34A; --success-light: #DCFCE7;
            --danger: #DC2626; --danger-light: #FEE2E2;
            --warning: #D97706; --r-card: 12px; --r-input: 8px;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-1); margin: 0; height: 100vh; overflow: hidden; display: flex; }

        .app-container { display: grid; grid-template-columns: 280px 1fr; width: 100%; height: 100%; }
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; }
        .brand { font-size: 16px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }

        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 10px; font-weight: 700; color: var(--text-2); text-transform: uppercase; margin-bottom: 4px; }
        input, select { width: 100%; height: 36px; padding: 0 10px; border: 1px solid var(--border); border-radius: var(--r-input); background: #F1F5F9; font-size: 13px; }
        input:focus, select:focus { background: #FFF; border-color: var(--primary); }
        .btn-primary { width: 100%; height: 40px; background: var(--primary); color: white; border: none; border-radius: var(--r-input); font-weight: 600; cursor: pointer; margin-top: 8px; }
        .btn-sec { width: 100%; height: 36px; background: white; color: var(--text-2); border: 1px solid var(--border); border-radius: var(--r-input); font-size: 12px; cursor: pointer; }

        .main-area { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 10px 16px; border-radius: var(--r-card); border: 1px solid var(--border); }
        .month-selector { display: flex; align-items: center; gap: 10px; position: relative; }
        .month-display { font-weight: 800; font-size: 14px; text-transform: uppercase; position: relative; }
        #dateInput { position: absolute; inset:0; opacity:0; cursor:pointer; }
        
        .dashboard-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; flex: 1; min-height: 0; }
        .t-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-card); display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .t-head { display: flex; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 800; color: white; text-transform: uppercase; }
        .th-col { flex: 1; padding: 10px; text-align: center; }
        .t-body { display: flex; flex: 1; overflow: hidden; }
        .t-column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .t-column:last-child { border-right: none; }
        .t-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; }
        .t-row { display: grid; grid-template-columns: 30px 80px 1fr auto 24px; align-items: center; gap: 8px; padding: 0 10px; height: 40px; border-bottom: 1px solid #F1F5F9; font-size: 12px; cursor: pointer; }
        .c-date { font-weight: 700; color: var(--text-3); text-align: center; }
        .c-cat { font-size: 9px; font-weight: 700; text-transform: uppercase; background: #F1F5F9; padding: 2px 4px; border-radius: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-desc { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-amt { font-weight: 700; text-align: right; }
        .c-btn { background: none; border: none; color: var(--text-3); cursor: pointer; opacity: 0.2; }
        .t-row:hover .c-btn { opacity: 1; }
        .t-total { padding: 10px; text-align: right; font-weight: 800; font-size: 13px; background: #F8FAFC; border-top: 1px solid var(--border); }

        .summary-column { display: flex; flex-direction: column; gap: 16px; }
        .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-card); padding: 16px; display: flex; flex-direction: column; }
        .balance-card.pos { background: var(--success-light); border-color: #BBF7D0; }
        .balance-card.neg { background: var(--danger-light); border-color: #FECACA; }
        .bal-amount { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; margin: 4px 0; }
        .chart-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-card); padding: 12px; height: 160px; position: relative; }
        .kpi-row-mini { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-card); }
        .tools { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="brand"><i class="fas fa-wallet"></i> Javier & Mary</div>
        <form id="txForm">
            <div class="form-group"><label>Fecha</label><input type="date" id="fDate" required></div>
            <div class="form-group"><label>Monto</label><input type="number" id="fAmount" placeholder="0.00" step="0.01" required></div>
            <div class="form-group"><label>Tipo</label><select id="fType" onchange="renderCats()"><option value="exp">ðŸ”´ Gasto</option><option value="inc">ðŸŸ¢ Ingreso</option></select></div>
            <div class="form-group"><label>CategorÃ­a</label><select id="fCat" onchange="renderConcepts()" required></select></div>
            <div class="form-group"><label>Concepto</label><select id="fConcept" onchange="checkNewConcept()" required></select><input type="text" id="fConceptCustom" placeholder="Nuevo..." style="display:none; margin-top:5px;"></div>
            <div style="display:flex; align-items:center; gap:6px; margin-bottom:12px; font-size:11px;"><input type="checkbox" id="fExec" checked style="width:14px; height:14px; margin:0;"><label for="fExec" style="margin:0; cursor:pointer;">Pagado</label></div>
            <button type="submit" id="btnSave" class="btn-primary">Guardar</button>
            <button type="button" id="btnCancel" onclick="resetForm()" class="btn-sec" style="display:none; border-color:var(--danger); color:var(--danger);">Cancelar</button>
        </form>
        <div class="tools">
            <button class="btn-sec" onclick="backup()">Backup</button>
            <button class="btn-sec" onclick="document.getElementById('fileIn').click()">Restaurar</button>
            <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
        </div>
    </aside>

    <main class="main-area">
        <header class="top-header">
            <div class="month-selector">
                <button style="border:none; background:none; cursor:pointer;" onclick="addMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <span class="month-display" id="monthTxt">...</span>
                <input type="month" id="dateInput" onchange="loadData()">
                <button style="border:none; background:none; cursor:pointer;" onclick="addMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div style="font-size:12px;">USD REF: $<input type="number" id="usdRate" value="1200" onchange="loadData()" style="width:60px; border:none; background:#F1F5F9; font-weight:700; text-align:right;"></div>
        </header>

        <section class="dashboard-grid">
            <div class="t-panel">
                <div class="t-head"><div class="th-col" style="background:var(--success)">Ingresos</div><div class="th-col" style="background:var(--danger)">Egresos</div></div>
                <div class="t-body">
                    <div class="t-column"><div class="t-list" id="t-list-inc"></div><div class="t-total" id="total-inc" style="color:var(--success)">$0</div></div>
                    <div class="t-column"><div class="t-list" id="t-list-exp"></div><div class="t-total" id="total-exp" style="color:var(--danger)">$0</div></div>
                </div>
            </div>
            <div class="summary-column">
                <div class="summary-card balance-card" id="cardBal"><span class="bal-amount" id="kpiBal">$0</span><span id="kpiUsd" style="font-size:13px; font-weight:600; color:var(--primary);">US$ 0.00</span></div>
                <div class="chart-box"><canvas id="myChart"></canvas></div>
                <div class="kpi-row-mini"><span>IN</span><span id="kpiInc" style="color:var(--success);">$0</span></div>
                <div class="kpi-row-mini"><span>OUT</span><span id="kpiExp" style="color:var(--danger);">$0</span></div>
            </div>
        </section>
    </main>
</div>

<script>
    const defData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Ventas','Varios'] }, concepts: { "Esenciales": ["Alquiler", "Luz/Gas", "Supermercado", "Internet", "Celular"], "Deudas": ["Tarjeta Visa", "Tarjeta Master", "Prestamo"], "Personal": ["Salidas", "Ropa", "Gym", "Regalos"], "Ahorro": ["Compra DÃ³lar", "Fondo InversiÃ³n"], "Sueldo": ["Javier", "Mary"], "Ventas": ["Venta 1", "Venta 2"], "Varios": ["DevoluciÃ³n", "Otros"] } };

    // CARGA DE DATOS MULTI-VERSIÃ“N
    let data = JSON.parse(localStorage.getItem('finData_v16')) || 
               JSON.parse(localStorage.getItem('finData_v15')) || 
               JSON.parse(localStorage.getItem('finData_v14')) || defData;

    let editId = null, chartInstance = null;

    window.onload = () => {
        const d = new Date();
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        document.getElementById('dateInput').value = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
        document.getElementById('usdRate').value = localStorage.getItem('usdRate') || 1200;
        renderCats(); loadData();
    };

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const dateObj = new Date(parseInt(y), parseInt(m)-1, 1);
        document.getElementById('monthTxt').innerText = `${dateObj.toLocaleString('es-ES', {month:'long'}).toUpperCase()} ${y}`;
        const txs = (data.txs || []).filter(t => t.date.startsWith(ym)).sort((a,b) => b.date.localeCompare(a.date));
        renderTView(txs); renderChart(txs); calcKPIs(txs);
    }

    function renderTView(txs) {
        const incList = document.getElementById('t-list-inc'), expList = document.getElementById('t-list-exp');
        incList.innerHTML = ''; expList.innerHTML = '';
        txs.forEach(t => {
            const day = t.date.split('-')[2], div = document.createElement('div');
            div.className = 't-row'; div.onclick = (e) => { if(!e.target.closest('.c-btn')) edit(t.id); };
            div.innerHTML = `<div class="c-date">${day}</div><div class="c-cat">${t.cat}</div><div class="c-desc">${t.desc}</div><div class="c-amt">$${Math.abs(t.amount).toLocaleString()}</div><button class="c-btn" onclick="del(${t.id})"><i class="fas fa-trash"></i></button>`;
            (t.type === 'inc' ? incList : expList).appendChild(div);
        });
    }

    function renderChart(txs) {
        const ctx = document.getElementById('myChart'); if(chartInstance) chartInstance.destroy();
        const exps = txs.filter(t => t.type === 'exp'), dataMap = exps.reduce((a,t) => { a[t.cat] = (a[t.cat]||0)+ +t.amount; return a; }, {});
        chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(dataMap), datasets: [{ data: Object.values(dataMap), backgroundColor: ['#EF4444','#F59E0B','#3B82F6','#10B981','#8B5CF6','#EC4899'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
    }

    function calcKPIs(txs) {
        let inc = 0, exp = 0; txs.forEach(t => { if(t.type === 'inc') inc += Math.abs(t.amount); else exp += Math.abs(t.amount); });
        const bal = inc - exp, rate = parseFloat(document.getElementById('usdRate').value) || 1200;
        document.getElementById('kpiInc').innerText = `$${inc.toLocaleString()}`;
        document.getElementById('kpiExp').innerText = `$${exp.toLocaleString()}`;
        document.getElementById('kpiBal').innerText = `$${bal.toLocaleString()}`;
        document.getElementById('kpiUsd').innerText = `US$ ${(bal/rate).toFixed(2)}`;
        document.getElementById('total-inc').innerText = `$${inc.toLocaleString()}`;
        document.getElementById('total-exp').innerText = `$${exp.toLocaleString()}`;
        const c = document.getElementById('cardBal'); c.className = 'summary-card balance-card ' + (bal >= 0 ? 'pos' : 'neg');
        document.getElementById('kpiBal').style.color = (bal >= 0 ? 'var(--success)' : 'var(--danger)');
    }

    function save() { localStorage.setItem('finData_v16', JSON.stringify(data)); }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download='backup_J&M.json'; a.click(); }
    
    // RESTAURACIÃ“N TOTALMENTE PERMISIVA
    function restoreSmart(input) {
        const fr = new FileReader();
        fr.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // Si el archivo tiene txs O transactions, lo rescatamos
                const txsToRestore = json.txs || json.transactions || null;
                
                if (txsToRestore && Array.isArray(txsToRestore)) {
                    data.txs = txsToRestore;
                    // Si el backup tiene sus propias categorias/conceptos, los traemos tambiÃ©n
                    if (json.cats) data.cats = json.cats;
                    if (json.concepts) data.concepts = json.concepts;
                    
                    save();
                    alert("Â¡RESTAURACIÃ“N COMPLETA!");
                    location.reload();
                } else {
                    alert("ERROR: El archivo no tiene movimientos reconocibles.");
                }
            } catch(err) {
                alert("ERROR CRÃTICO: El archivo no es un JSON vÃ¡lido.");
            }
        };
        fr.readAsText(input.files[0]);
    }

    function renderCats() { const sel = document.getElementById('fCat'); sel.innerHTML = ''; (data.cats[document.getElementById('fType').value] || []).forEach(c => sel.add(new Option(c,c))); sel.add(new Option('+ Nueva', 'new_cat')); renderConcepts(); }
    function renderConcepts() { const cat = document.getElementById('fCat').value; if(cat === 'new_cat') { const n = prompt('CategorÃ­a:'); if(n) { data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; save(); renderCats(); document.getElementById('fCat').value = n; renderConcepts(); } return; } const sel = document.getElementById('fConcept'); sel.innerHTML = ''; (data.concepts[cat] || []).forEach(c => sel.add(new Option(c,c))); sel.add(new Option('+ Nuevo', 'new_con')); checkNewConcept(); }
    function checkNewConcept() { const val = document.getElementById('fConcept').value, customInp = document.getElementById('fConceptCustom'); customInp.style.display = (val === 'new_con') ? 'block' : 'none'; if(val === 'new_con') customInp.focus(); }
    document.getElementById('txForm').onsubmit = (e) => { e.preventDefault(); let finalDesc = document.getElementById('fConcept').value; const cat = document.getElementById('fCat').value; if(finalDesc === 'new_con') { finalDesc = document.getElementById('fConceptCustom').value; if(!data.concepts[cat]) data.concepts[cat] = []; if(!data.concepts[cat].includes(finalDesc)) { data.concepts[cat].push(finalDesc); } } const tx = { id: editId || Date.now(), date: document.getElementById('fDate').value, amount: Math.abs(document.getElementById('fAmount').value), type: document.getElementById('fType').value, cat: cat, desc: finalDesc, exec: document.getElementById('fExec').checked }; if(editId) { const idx = data.txs.findIndex(t => t.id == editId); if(idx!==-1) data.txs[idx]=tx; } else { data.txs.push(tx); } save(); resetForm(); loadData(); };
    function edit(id) { const t = data.txs.find(x => x.id == id); if(!t) return; editId = id; document.getElementById('fDate').value = t.date; document.getElementById('fAmount').value = t.amount; document.getElementById('fType').value = t.type; renderCats(); document.getElementById('fCat').value = t.cat; renderConcepts(); if(!document.getElementById('fConcept').querySelector(`option[value="${t.desc}"]`)) { const opt = new Option(t.desc, t.desc); document.getElementById('fConcept').add(opt, 0); } document.getElementById('fConcept').value = t.desc; document.getElementById('fExec').checked = t.exec; document.getElementById('btnSave').innerText = 'ACTUALIZAR'; document.getElementById('btnCancel').style.display = 'block'; }
    function resetForm() { editId = null; document.getElementById('txForm').reset(); document.getElementById('fDate').value = new Date().toISOString().split('T')[0]; document.getElementById('btnSave').innerText = 'Guardar'; document.getElementById('btnCancel').style.display = 'none'; }
    function del(id) { if(confirm("Â¿Eliminar?")) { data.txs = data.txs.filter(t => t.id != id); save(); loadData(); } }
    function addMonth(n) { const inp=document.getElementById('dateInput'); let [y,m]=inp.value.split('-'); const d=new Date(y,m-1+n,1); inp.value=`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`; loadData(); }
</script>
</body>
</html>
