<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>J&M Pro V30</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-app: #F1F5F9; --surface: #FFFFFF;
            --text-dark: #1E293B; --text-gray: #64748B;
            --inc-color: #10B981; --inc-bg: #ECFDF5;
            --exp-color: #EF4444; --exp-bg: #FEF2F2;
            --primary: #2563EB;
            --border: #E2E8F0;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-app); 
            margin: 0; height: 100vh; overflow: hidden; /* IMPORTANTE: Bloquea scroll de página */
            display: flex; flex-direction: column; color: var(--text-dark);
        }

        /* --- 1. HEADER TIPO COMANDO --- */
        .top-bar {
            background: var(--surface); height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .brand { font-weight: 800; color: var(--primary); font-size: 16px; display:flex; align-items:center; gap:8px;}
        
        .date-cmd { 
            display: flex; align-items: center; background: #F8FAFC; 
            border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
        }
        .btn-cmd { 
            background: transparent; border: none; padding: 8px 12px; 
            cursor: pointer; color: var(--text-gray); font-size: 14px;
        }
        .btn-cmd:active { background: #E2E8F0; color: var(--text-dark); }
        .date-label { 
            font-size: 13px; font-weight: 700; text-transform: uppercase; 
            min-width: 110px; text-align: center; border-left: 1px solid var(--border); border-right: 1px solid var(--border);
            padding: 6px 0; position: relative;
        }

        /* --- 2. BALANCE CARD (ESTILO DESKTOP) --- */
        .kpi-section { padding: 10px; flex-shrink: 0; }
        .kpi-card {
            background: var(--surface); padding: 12px 15px; border-radius: 12px;
            border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .kpi-main div:first-child { font-size: 10px; font-weight: 700; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-val { font-size: 24px; font-weight: 800; letter-spacing: -1px; margin-top: 2px; }
        .kpi-sec { text-align: right; }
        .usd-val { font-size: 14px; font-weight: 600; color: var(--text-gray); display:block; margin-bottom:4px;}
        .usd-inp { width: 60px; font-size: 11px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; text-align: right; }

        /* --- 3. T-VIEW CON SCROLL INTERNO (CORE) --- */
        .t-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            padding: 0 10px; flex: 1; min-height: 0; /* Clave para que el flex funcione con scroll */
        }
        .t-col { display: flex; flex-direction: column; height: 100%; border-radius: 12px 12px 0 0; overflow: hidden; background: var(--surface); border: 1px solid var(--border); }
        
        .col-header { 
            padding: 10px; text-align: center; color: white; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .bg-inc { background: var(--inc-color); }
        .bg-exp { background: var(--exp-color); }

        /* ZONA DE SCROLL MÁGICA */
        .col-scroll { 
            overflow-y: auto; flex: 1; padding: 5px; 
            scrollbar-width: thin; /* Firefox */
        }
        .col-scroll::-webkit-scrollbar { width: 4px; }
        .col-scroll::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }

        /* --- 4. FILAS COMPACTAS (DENSIDAD) --- */
        .row-item {
            display: flex; align-items: center; padding: 6px 8px; 
            border-bottom: 1px solid #F1F5F9; cursor: pointer; position: relative;
        }
        .row-date { font-size: 11px; font-weight: 700; color: var(--text-gray); width: 20px; text-align: center; margin-right: 6px; line-height: 1; }
        .row-body { flex: 1; overflow: hidden; }
        .row-main { font-size: 11px; font-weight: 600; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .row-sub { font-size: 9px; color: var(--text-gray); text-transform: uppercase; display:flex; align-items:center; gap:4px; margin-top:2px;}
        .row-amt { font-size: 12px; font-weight: 800; text-align: right; margin-left: 5px; }
        .c-inc { color: var(--inc-color); } .c-exp { color: var(--exp-color); }

        /* ALERTA */
        .alert-icon { font-size: 9px; color: #F59E0B; margin-left: 2px; }

        /* --- 5. GRÁFICO (INFERIOR FIJO) --- */
        .chart-footer {
            height: 140px; background: var(--surface); border-top: 1px solid var(--border);
            padding: 10px; flex-shrink: 0; display:flex; gap:10px;
        }
        .chart-legend { width: 100px; overflow-y:auto; font-size:10px; }
        .legend-item { display:flex; align-items:center; gap:5px; margin-bottom:4px; cursor:pointer;}
        .dot { width:8px; height:8px; border-radius:50%; }

        /* FAB & FORM */
        .fab { position: fixed; bottom: 150px; right: 20px; width: 50px; height: 50px; background: var(--text-dark); color: white; border-radius: 50%; border:none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 20px; cursor: pointer; z-index: 10; }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; display: none; backdrop-filter: blur(2px); }
        .sheet { 
            position: fixed; bottom: 0; width: 100%; background: white; z-index: 100;
            border-radius: 20px 20px 0 0; transform: translateY(100%); transition: 0.3s;
            padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .sheet.open { transform: translateY(0); }
        
        /* INPUTS MODERNOS */
        .inp-grp { margin-bottom: 12px; }
        .inp-lbl { font-size: 10px; font-weight: 700; color: var(--text-gray); margin-bottom: 4px; display: block; text-transform: uppercase; }
        .inp { width: 100%; height: 40px; border: 1px solid var(--border); border-radius: 8px; padding: 0 10px; font-size: 14px; background: #F8FAFC; font-family:inherit; }
        
        .switch-type { display: flex; background: #F1F5F9; padding: 3px; border-radius: 8px; margin-bottom: 15px; }
        .sw-btn { flex: 1; border: none; background: transparent; padding: 8px; font-size: 12px; font-weight: 600; border-radius: 6px; color: var(--text-gray); }
        .sw-btn.active-inc { background: white; color: var(--inc-color); shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight:800; }
        .sw-btn.active-exp { background: white; color: var(--exp-color); shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight:800; }
        
        .btn-main { width: 100%; height: 45px; background: var(--text-dark); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>

<header class="top-bar">
    <div class="brand"><i class="fas fa-wallet"></i> J&M</div>
    <div class="date-cmd">
        <button class="btn-cmd" onclick="navMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="date-label">
            <span id="monthTxt">...</span>
            <input type="month" id="dateInput" onchange="loadData()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </div>
        <button class="btn-cmd" onclick="navMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
    <button class="btn-cmd" onclick="backup()"><i class="fas fa-cloud-download-alt"></i></button>
</header>

<div class="kpi-section">
    <div class="kpi-card">
        <div class="kpi-main">
            <div>Balance Neto</div>
            <div class="kpi-val" id="kpiBal">$0</div>
        </div>
        <div class="kpi-sec">
            <span class="usd-val" id="kpiUsd">USD 0.00</span>
            <div style="display:flex; align-items:center; gap:5px; justify-content:flex-end;">
                <span style="font-size:10px; color:#94A3B8;">BLUE:</span>
                <input type="number" id="usdRate" value="1200" class="usd-inp" onchange="loadData()">
            </div>
        </div>
    </div>
</div>

<div class="t-grid">
    <div class="t-col">
        <div class="col-header bg-inc">
            <span>Ingresos</span>
            <span id="sum-inc" style="background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">$0</span>
        </div>
        <div class="col-scroll" id="list-inc">
            </div>
    </div>

    <div class="t-col">
        <div class="col-header bg-exp">
            <span>Egresos</span>
            <span id="sum-exp" style="background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">$0</span>
        </div>
        <div class="col-scroll" id="list-exp">
            </div>
    </div>
</div>

<div class="chart-footer">
    <div style="flex:1; position:relative;">
        <canvas id="myChart"></canvas>
    </div>
    <div class="chart-legend" id="chartLegend"></div>
</div>

<button class="fab" onclick="openSheet()"><i class="fas fa-plus"></i></button>

<div class="sheet" id="sheet">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <span style="font-weight:800;" id="formTitle">Nuevo Movimiento</span>
        <span onclick="closeSheet()" style="cursor:pointer;"><i class="fas fa-times"></i></span>
    </div>
    <form id="txForm">
        <div class="switch-type">
            <button type="button" class="sw-btn" id="btn-exp" onclick="setType('exp')">Gasto</button>
            <button type="button" class="sw-btn" id="btn-inc" onclick="setType('inc')">Ingreso</button>
        </div>
        <input type="hidden" id="fType" value="exp">
        
        <div style="display:flex; gap:10px;">
            <div class="inp-grp" style="flex:1">
                <label class="inp-lbl">Monto</label>
                <input type="number" id="fAmount" class="inp" placeholder="0.00" step="0.01" required>
            </div>
            <div class="inp-grp" style="flex:1">
                <label class="inp-lbl">Fecha</label>
                <input type="date" id="fDate" class="inp" required>
            </div>
        </div>

        <div class="inp-grp">
            <label class="inp-lbl">Categoría</label>
            <select id="fCat" class="inp" onchange="renderConcepts()" required></select>
        </div>

        <div class="inp-grp">
            <label class="inp-lbl">Concepto</label>
            <select id="fConcept" class="inp" onchange="checkNewConcept()" required></select>
            <input type="text" id="fConceptCustom" class="inp" style="margin-top:5px; display:none;" placeholder="Nombre del concepto...">
        </div>

        <div style="margin-bottom:20px; display:flex; gap:10px; align-items:center;">
            <input type="checkbox" id="fExec" checked> <label for="fExec" style="font-size:12px;">Ya pagado/cobrado</label>
        </div>

        <button type="submit" id="btnSave" class="btn-main">GUARDAR</button>
        
        <div id="delBox" style="display:none; margin-top:10px;">
            <button type="button" onclick="del(editId)" style="width:100%; color:#EF4444; background:none; border:none; font-weight:700;">Eliminar</button>
        </div>
        <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
        <div style="text-align:center; margin-top:10px; font-size:10px; color:#94A3B8;" onclick="document.getElementById('fileIn').click()">Restaurar Backup</div>
    </form>
</div>

<script>
    // --- DATA KERNEL (Misma lógica, mejor UI) ---
    const defData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Ventas','Varios'] }, concepts: { "Esenciales": ["Alquiler", "Luz/Gas", "Supermercado"], "Deudas": ["Tarjeta Visa"], "Sueldo": ["Javier", "Mary"] } };
    let data = JSON.parse(localStorage.getItem('finData_v16')) || defData;
    let editId = null, chartInstance = null;

    window.onload = () => {
        const d = new Date();
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        document.getElementById('dateInput').value = d.toISOString().slice(0, 7);
        if(localStorage.getItem('usdRate')) document.getElementById('usdRate').value = localStorage.getItem('usdRate');
        loadData();
    };

    // --- UI HELPERS ---
    function openSheet() { if(!editId) resetForm(); document.getElementById('sheet').classList.add('open'); document.getElementById('overlay').style.display='block'; }
    function closeSheet() { document.getElementById('sheet').classList.remove('open'); document.getElementById('overlay').style.display='none'; setTimeout(resetForm,300); }
    function navMonth(n) { 
        const i = document.getElementById('dateInput'); let [y,m]=i.value.split('-'); 
        i.value = new Date(y,m-1+n,1).toISOString().slice(0,7); loadData(); 
    }

    // --- MAIN LOGIC ---
    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('monthTxt').innerText = `${months[parseInt(m)-1]} ${y}`;
        
        // Filtrar y ordenar por FECHA (Descendente)
        const currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym)).sort((a,b) => b.date.localeCompare(a.date));
        
        renderT(currentTxs);
        renderChart(currentTxs);
        renderCats();
        localStorage.setItem('usdRate', document.getElementById('usdRate').value);
    }

    function renderT(txs) {
        const lInc = document.getElementById('list-inc'), lExp = document.getElementById('list-exp');
        lInc.innerHTML = ''; lExp.innerHTML = '';
        let tInc=0, tExp=0; const today = new Date().toISOString().split('T')[0];

        txs.forEach(t => {
            const isInc = t.type === 'inc';
            const amt = Math.abs(t.amount);
            if(isInc) tInc += amt; else tExp += amt;

            // Lógica de Alerta (5 días)
            let alertHTML = '';
            if(!t.exec) {
                const diff = (new Date(t.date) - new Date(today)) / (1000*60*60*24);
                if(diff <= 5) alertHTML = `<i class="fas fa-clock alert-icon"></i>`;
            }

            const row = document.createElement('div');
            row.className = 'row-item';
            row.onclick = () => edit(t.id);
            row.innerHTML = `
                <div class="row-date">${t.date.split('-')[2]}</div>
                <div class="row-body">
                    <div class="row-main">${t.desc}</div>
                    <div class="row-sub">
                        <span style="background:${isInc?'#ECFDF5':'#F1F5F9'}; color:${isInc?'#059669':'#64748B'}; padding:1px 4px; border-radius:3px;">${t.cat}</span>
                        ${alertHTML}
                    </div>
                </div>
                <div class="row-amt ${isInc?'c-inc':'c-exp'}">${isInc?'+':''}$${Math.floor(amt).toLocaleString()}</div>
            `;
            (isInc ? lInc : lExp).appendChild(row);
        });

        document.getElementById('sum-inc').innerText = `$${tInc.toLocaleString()}`;
        document.getElementById('sum-exp').innerText = `$${tExp.toLocaleString()}`;
        
        const bal = tInc - tExp;
        const balEl = document.getElementById('kpiBal');
        balEl.innerText = `$${bal.toLocaleString()}`;
        balEl.style.color = bal >= 0 ? 'var(--inc-color)' : 'var(--exp-color)'; // Condicional de color

        const rate = parseFloat(document.getElementById('usdRate').value) || 1;
        document.getElementById('kpiUsd').innerText = `US$ ${(bal/rate).toFixed(2)}`;
    }

    // --- FORM LOGIC ---
    function setType(t) {
        document.getElementById('fType').value = t;
        document.getElementById('btn-inc').className = `sw-btn ${t=='inc'?'active-inc':''}`;
        document.getElementById('btn-exp').className = `sw-btn ${t=='exp'?'active-exp':''}`;
        renderCats();
    }
    function renderCats() {
        const t = document.getElementById('fType').value;
        const s = document.getElementById('fCat'); s.innerHTML='';
        (data.cats[t]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Crear...','new'));
        renderConcepts();
    }
    function renderConcepts() {
        const cVal = document.getElementById('fCat').value;
        if(cVal==='new'){ 
            const n=prompt('Nueva Categoría:'); 
            if(n){ data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; save(); renderCats(); document.getElementById('fCat').value=n; } 
            else { renderCats(); return; }
        }
        const s = document.getElementById('fConcept'); s.innerHTML='';
        (data.concepts[cVal]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Nuevo...','new_c'));
        checkNewConcept();
    }
    function checkNewConcept() {
        const isNew = document.getElementById('fConcept').value==='new_c';
        document.getElementById('fConceptCustom').style.display=isNew?'block':'none';
    }
    
    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value;
        let desc = document.getElementById('fConcept').value;
        if(desc==='new_c') {
            desc=document.getElementById('fConceptCustom').value;
            if(!desc) return;
            if(!data.concepts[cat]) data.concepts[cat]=[];
            data.concepts[cat].push(desc);
        }
        const tx = { id:editId||Date.now(), date:document.getElementById('fDate').value, amount:parseFloat(document.getElementById('fAmount').value), type:document.getElementById('fType').value, cat, desc, exec:document.getElementById('fExec').checked };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i!==-1) data.txs[i]=tx; } else data.txs.push(tx);
        save(); closeSheet(); loadData();
    }

    function edit(id) {
        const t = data.txs.find(x=>x.id==id); if(!t)return;
        editId=id; document.getElementById('formTitle').innerText='Editar';
        document.getElementById('fDate').value=t.date; document.getElementById('fAmount').value=Math.abs(t.amount);
        document.getElementById('fExec').checked=t.exec;
        setType(t.type); document.getElementById('fCat').value=t.cat; renderConcepts();
        
        const s=document.getElementById('fConcept');
        let has=false; for(let i=0;i<s.options.length;i++) if(s.options[i].value==t.desc) has=true;
        if(!has) s.add(new Option(t.desc,t.desc),0); s.value=t.desc;
        
        checkNewConcept(); document.getElementById('delBox').style.display='block'; document.getElementById('btnSave').innerText='ACTUALIZAR';
        document.getElementById('sheet').classList.add('open'); document.getElementById('overlay').style.display='block';
    }
    function resetForm() { editId=null; document.getElementById('txForm').reset(); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('formTitle').innerText='Nuevo'; document.getElementById('delBox').style.display='none'; document.getElementById('fConceptCustom').style.display='none'; document.getElementById('btnSave').innerText='GUARDAR'; setType('exp'); }
    function del(id) { if(confirm('¿Borrar?')) { data.txs=data.txs.filter(x=>x.id!=id); save(); closeSheet(); loadData(); } }

    // --- CHART & UTILS ---
    function renderChart(txs) {
        const ctx = document.getElementById('myChart'); if(chartInstance) chartInstance.destroy();
        const exps = txs.filter(t=>t.type==='exp');
        const map = exps.reduce((a,t)=>{ a[t.cat]=(a[t.cat]||0)+t.amount; return a; }, {});
        const colors = ['#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6'];
        
        // Render Leyenda HTML (Para ahorrar espacio en canvas)
        const leg = document.getElementById('chartLegend'); leg.innerHTML='';
        Object.keys(map).forEach((k,i) => {
            leg.innerHTML += `<div class="legend-item" onclick="alert('${k}: $${map[k].toLocaleString()}')"><div class="dot" style="background:${colors[i%colors.length]}"></div>${k}</div>`;
        });

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(map), datasets: [{ data: Object.values(map), backgroundColor: colors, borderWidth:0 }] },
            options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{display:false}} }
        });
    }

    function save() { localStorage.setItem('finData_v16', JSON.stringify(data)); }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download=`J&M_Backup.json`; a.click(); }
    function restoreSmart(i) { const r=new FileReader(); r.onload=e=>{ try{data=JSON.parse(e.target.result); save(); location.reload();}catch(x){alert('Error');} }; r.readAsText(i.files[0]); }
</script>
</body>
</html>
