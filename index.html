<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuentas Javier y Mary v10.2 (Compact Fix)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            --bg-app: #F7F9FC; --surface-1: #FFFFFF; --surface-2: #F1F5FB; --border: #D7E0EE;
            --text-1: #0B1220; --text-2: #334155; --text-3: #64748B;
            --primary: #2563EB; --primary-hover: #1D4ED8; --primary-pressed: #1E40AF; --focus-ring: rgba(37, 99, 235, 0.35);
            --success: #16A34A; --danger: #DC2626; --warning: #D97706; --info: #0284C7;
            --success-bg: #EAF7EF; --danger-bg: #FDECEC; --warning-bg: #FFF4E5; --info-bg: #E7F6FD; --neutral-bg: #F1F5F9;
            --r-card: 16px; --r-btn: 12px; --r-input: 10px; --r-chip: 999px;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-1); margin: 0; padding: 20px; font-size: 13px; -webkit-font-smoothing: antialiased; }

        /* --- LAYOUT --- */
        .grid-container { display: grid; grid-template-columns: 1fr 340px; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: start; }
        @media (max-width: 900px) { .grid-container { grid-template-columns: 1fr; } }
        .card { background: var(--surface-1); border: 1px solid var(--border); border-radius: var(--r-card); padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); margin-bottom: 20px; }
        
        /* --- TOP BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--surface-1); padding: 10px 20px; border-radius: var(--r-card); border: 1px solid var(--border); }
        .app-title { display: flex; align-items: center; gap: 10px; color: var(--primary); font-weight: 700; font-size: 1.2em; }

        /* NavegaciÃ³n Meses */
        .month-nav { display: flex; align-items: center; gap: 4px; background: var(--surface-2); padding: 3px; border-radius: var(--r-btn); border: 1px solid var(--border); }
        .month-nav button { border: none; background: transparent; cursor: pointer; color: var(--text-2); padding: 6px 8px; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .month-nav button:hover { background: #E2E8F0; color: var(--text-1); }
        
        .month-display-wrapper { position: relative; width: 90px; height: 28px; display: flex; align-items: center; justify-content: center; }
        #monthLabel { font-weight: 700; font-size: 12px; color: var(--text-1); text-transform: uppercase; letter-spacing: 0.5px; pointer-events: none; }
        #currentMonth { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        /* --- KPIS --- */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .kpi-card { background: var(--surface-1); border: 1px solid var(--border); padding: 12px 16px; border-radius: var(--r-card); display: flex; flex-direction: column; border-left: 4px solid transparent; }
        .kpi-card.blue { border-left-color: var(--primary); }
        .kpi-card.green { border-left-color: var(--success); }
        .kpi-card.info { border-left-color: var(--info); }
        .kpi-label { font-size: 10px; color: var(--text-3); font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .kpi-value { font-size: 20px; font-weight: 700; color: var(--text-1); letter-spacing: -0.5px; }
        .kpi-input { background: var(--surface-2); border: 1px solid var(--border); color: var(--text-1); font-size: 14px; width: 80px; padding: 2px 6px; border-radius: 6px; font-weight: 600; }

        /* --- TABLA ULTRA COMPACTA (FIX) --- */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--r-btn); }
        table { width: 100%; border-collapse: collapse; min-width: 650px; }
        
        /* FIX: white-space nowrap obliga a 1 sola lÃ­nea */
        th { text-align: left; background: var(--surface-2); padding: 8px 12px; color: var(--text-3); font-weight: 600; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
        
        /* FIX: padding reducido y nowrap */
        td { padding: 6px 12px; border-bottom: 1px solid var(--border); color: var(--text-2); font-size: 13px; white-space: nowrap; height: 38px; vertical-align: middle; }
        
        tr:hover { background-color: #F8FAFC; }
        
        .amount-pos { color: var(--success); font-weight: 600; }
        .amount-neg { color: var(--text-1); font-weight: 600; }
        .tag { padding: 2px 8px; border-radius: var(--r-chip); font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; white-space: nowrap; }
        .tag.efectivo { background: var(--warning-bg); color: var(--warning); }
        .tag.banco { background: var(--info-bg); color: var(--info); }
        .tag.green { background: var(--success-bg); color: var(--success); }
        .tag.gray { background: var(--neutral-bg); color: var(--text-2); }
        .date-alert { color: var(--danger); font-weight: 600; background: var(--danger-bg); padding: 1px 5px; border-radius: 4px; }

        /* --- CONTABLE --- */
        .accounting-view { display: flex; gap: 20px; margin-top: 12px; }
        .acc-column { flex: 1; border: 1px solid var(--border); border-radius: var(--r-btn); background: var(--surface-1); overflow: hidden; }
        .acc-header { padding: 8px; text-align: center; color: white; font-weight: 600; font-size: 12px; text-transform: uppercase; }
        .acc-header.inc { background: var(--success); }
        .acc-header.exp { background: var(--danger); }
        .acc-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .acc-item { display: flex; justify-content: space-between; padding: 6px 12px; border-bottom: 1px solid var(--border); font-size: 12px; white-space: nowrap; }
        .acc-total { padding: 8px 12px; text-align: right; font-weight: 700; font-size: 13px; background: var(--surface-2); border-top: 1px solid var(--border); }

        .btn-switch { background: var(--surface-2); border: 1px solid var(--border); color: var(--text-2); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; }
        .btn-switch:hover { background: #E2E8F0; color: var(--primary); }

        /* --- FORM --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; } 
        .form-full { grid-column: span 2; }
        .form-group { margin-bottom: 2px; }
        label { display: block; font-size: 11px; margin-bottom: 4px; font-weight: 600; color: var(--text-3); text-transform: uppercase; }
        input, select { width: 100%; height: 36px; padding: 0 10px; border: 1px solid var(--border); border-radius: var(--r-input); font-size: 13px; color: var(--text-1); background: var(--surface-1); }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--focus-ring); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; background: var(--surface-1); padding: 0 10px; border-radius: var(--r-input); cursor: pointer; height: 36px; border: 1px solid var(--border); }
        .checkbox-wrapper input { width: 14px; height: 14px; accent-color: var(--primary); }
        
        .input-group { display: flex; gap: 6px; }
        .btn-mini-del { background: var(--danger-bg); color: var(--danger); border: none; border-radius: 8px; width: 36px; cursor: pointer; }
        .btn-mini-del:hover { background: #fee2e2; }

        button.btn-main { background: var(--primary); color: white; border: none; width: 100%; border-radius: var(--r-btn); cursor: pointer; font-weight: 600; font-size: 13px; height: 40px; margin-top: 10px; }
        button.btn-main:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button.btn-main.editing { background: var(--warning); }
        button.btn-sec { background: white; border: 1px solid var(--border); color: var(--text-2); border-radius: var(--r-btn); height: 34px; font-weight: 500; cursor: pointer; font-size: 12px; }
        
        .action-btn { border: none; background: none; cursor: pointer; font-size: 14px; margin: 0 2px; padding: 2px; }
        .btn-edit { color: var(--warning); } .btn-del { color: var(--danger); }
        
        #customConceptContainer, #customCategoryContainer { display: none; margin-top: 6px; }
        #chart-reset-btn { display: none; margin-left: auto; font-size: 11px; padding: 2px 6px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="app-title">
        <i class="fas fa-wallet" style="color:var(--primary)"></i>
        <span>Cuentas Javier y Mary</span>
    </div>
    <div class="month-nav">
        <button onclick="changeMonth(-1)" title="Anterior"><i class="fas fa-chevron-left"></i></button>
        <div class="month-display-wrapper">
            <span id="monthLabel">DIC 2025</span> 
            <input type="month" id="currentMonth" onchange="loadData()"> 
        </div>
        <button onclick="changeMonth(1)" title="Siguiente"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div class="grid-container">
    
    <div class="main-col">
        <div class="kpi-row">
            <div class="kpi-card blue">
                <span class="kpi-label">DÃ“LAR REF.</span>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:1.1em; color:var(--text-3);">$</span>
                    <input type="number" id="manualDolar" class="kpi-input" value="1200" onchange="updateDolarImpact()">
                </div>
            </div>
            <div class="kpi-card green">
                <span class="kpi-label">Balance Mes</span>
                <div class="kpi-value" id="month-balance">$0.00</div>
            </div>
            <div class="kpi-card info">
                <span class="kpi-label">Ahorro USD</span>
                <div class="kpi-value" id="usd-savings" style="color:var(--info)">$0.00</div>
            </div>
        </div>

        <div class="card" style="min-height: 550px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:12px;">
                <h3 style="margin:0; font-size:14px;"><i class="fas fa-list-ul" style="color:var(--text-3)"></i> Movimientos</h3>
                <button class="btn-switch" onclick="toggleViewMode()" id="viewToggleBtn"><i class="fas fa-exchange-alt"></i> Cambiar Vista</button>
            </div>

            <div id="view-list" class="table-wrapper">
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th width="40px" style="text-align:center;"></th>
                            <th width="90px">Fecha</th>
                            <th width="120px">CategorÃ­a</th>
                            <th width="auto">Concepto</th>
                            <th width="110px" style="text-align:right;">Monto</th>
                            <th width="70px" style="text-align:center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="list"></tbody>
                </table>
            </div>

            <div id="view-accounting" class="accounting-view" style="display:none;">
                <div class="acc-column">
                    <div class="acc-header inc">INGRESOS</div>
                    <ul class="acc-list" id="acc-list-inc"></ul>
                    <div class="acc-total" style="color:var(--success)" id="acc-total-inc">$0.00</div>
                </div>
                <div class="acc-column">
                    <div class="acc-header exp">EGRESOS</div>
                    <ul class="acc-list" id="acc-list-exp"></ul>
                    <div class="acc-total" style="color:var(--danger)" id="acc-total-exp">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card" id="form-card">
            <h3 id="form-title" style="color:var(--primary); font-size:14px;"><i class="fas fa-plus-circle"></i> Nuevo Registro</h3>
            <form id="form">
                <div class="form-grid">
                    <div class="form-group form-full">
                        <label>Fecha</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group form-full">
                        <label>Estado</label>
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="executed" checked>
                            <span>Movimiento Ejecutado</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="type" onchange="updateCategoryLogic()" style="font-weight:500;">
                            <option value="expense">ðŸ”´ Egreso</option>
                            <option value="income">ðŸŸ¢ Ingreso</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Monto</label>
                        <input type="number" id="amount" placeholder="0.00" required step="0.01">
                    </div>

                    <div class="form-group form-full">
                        <label>CategorÃ­a</label>
                        <div class="input-group">
                            <select id="category" onchange="updateConceptLogic()" required></select>
                            <button type="button" class="btn-mini-del" onclick="deleteCurrentCategory()" title="Borrar CategorÃ­a"><i class="fas fa-trash"></i></button>
                        </div>
                        <div id="customCategoryContainer">
                            <input type="text" id="customCategoryInput" placeholder="Nombre nueva categorÃ­a...">
                        </div>
                    </div>

                    <div class="form-group form-full">
                        <label>Concepto</label>
                        <div class="input-group">
                            <select id="conceptSelect" onchange="handleConceptChange()" required></select>
                            <button type="button" class="btn-mini-del" onclick="deleteCurrentConcept()" title="Borrar Concepto"><i class="fas fa-trash"></i></button>
                        </div>
                        <div id="customConceptContainer">
                            <input type="text" id="customConceptInput" placeholder="Nombre nuevo concepto...">
                        </div>
                    </div>

                </div>

                <button type="submit" id="btn-submit" class="btn-main">Registrar Movimiento</button>
                <button type="button" id="btn-cancel" onclick="cancelEdit()" style="display:none; width:100%; margin-top:8px;" class="btn-sec">Cancelar</button>
            </form>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="chart-title" style="margin:0; font-size:13px; color:var(--text-2);">DistribuciÃ³n</h3>
                <button id="chart-reset-btn" onclick="resetChartLevel()">â¬… Volver</button>
            </div>
            <div style="height: 200px; width: 100%; margin-top:12px;">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <div class="card" style="background: var(--surface-2); border:none;">
            <h3 style="font-size:12px; color:var(--text-3); text-transform:uppercase;">Data & Backup</h3>
            <div style="display:flex; gap:8px; margin-bottom:12px;">
                <button class="btn-sec" onclick="downloadData()" style="flex:1;"><i class="fas fa-download"></i> Backup</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                <button class="btn-sec" onclick="document.getElementById('importFile').click()" style="flex:1;"><i class="fas fa-upload"></i> Restaurar</button>
            </div>
            <div style="border-top:1px solid #E2E8F0; padding-top:10px;">
                <label style="margin-bottom:6px;">Copiar desde otro mes:</label>
                <div style="display:flex; gap:6px;">
                    <input type="month" id="cloneSourceMonth" style="background:white; height:34px;">
                    <button onclick="cloneMonthData()" class="btn-sec" style="width:auto; padding:0 12px; background:var(--primary); color:white; border:none;">Copiar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. DATOS ---
    const defaultData = {
        categories: {
            income: ["Ingresos Generales"],
            expense: ["Esenciales", "Deudas", "Personal", "Ahorro"]
        },
        concepts: {
            "Ingresos Generales": ["Salario Javier", "Salario Mary", "Ingreso Colombia", "Venta DÃ³lar", "Aguinaldo", "Devoluciones"],
            "Esenciales": ["Alquiler", "Colegio", "Expensas", "Luz/Gas", "Supermercado", "Internet/TV", "Seguro Auto", "Nafta"],
            "Deudas": ["Tarjeta BBVA", "Tarjeta ICBC", "PrÃ©stamo BBVA", "PrÃ©stamo ICBC", "Patente"],
            "Personal": ["Comida Delivery", "Almuerzo Helena", "Gimnasio", "Salidas"],
            "Ahorro": ["Compra DÃ³lar", "Fondo InversiÃ³n"]
        }
    };

    let appData = JSON.parse(localStorage.getItem('appData_v8')) || defaultData;
    let transactions = JSON.parse(localStorage.getItem('transactions_v4')) || [];
    let isAccountingView = false;
    let editingId = null;
    let chartLevel = 'category';
    let chartFilterCategory = null;

    // --- 2. INICIO ---
    window.onload = function() {
        const today = new Date();
        const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        document.getElementById('date').value = localDate;
        
        // Cargar mes actual
        document.getElementById('currentMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        
        const savedDolar = localStorage.getItem('savedDolarRate');
        if(savedDolar) document.getElementById('manualDolar').value = savedDolar;

        updateCategoryLogic();
        loadData();
    };

    // --- 3. LOGICA FECHA VISUAL ---
    function updateMonthLabel() {
        const inputVal = document.getElementById('currentMonth').value; 
        if (!inputVal) return;
        const [year, month] = inputVal.split('-');
        const date = new Date(parseInt(year), parseInt(month) - 1, 2); 
        const monthName = date.toLocaleString('es-ES', { month: 'short' }).toUpperCase().replace('.', '');
        document.getElementById('monthLabel').innerText = `${monthName} ${year}`;
    }

    function changeMonth(step) {
        const input = document.getElementById('currentMonth');
        const currentVal = input.value; 
        if(!currentVal) return;
        let [year, month] = currentVal.split('-').map(Number);
        const date = new Date(year, month - 1 + step, 1);
        const newYear = date.getFullYear();
        const newMonth = String(date.getMonth() + 1).padStart(2, '0');
        input.value = `${newYear}-${newMonth}`;
        loadData();
    }

    // --- 4. LOGICA DROPDOWNS ---
    function updateCategoryLogic() {
        const type = document.getElementById('type').value;
        const catSelect = document.getElementById('category');
        const currentCat = catSelect.value;
        catSelect.innerHTML = '';
        
        let cats = type === 'income' ? appData.categories.income : appData.categories.expense;
        cats = [...cats].sort();
        cats.push("Otro");

        cats.forEach(c => {
            const el = document.createElement('option');
            el.value = c; el.innerText = c;
            catSelect.appendChild(el);
        });

        if(cats.includes(currentCat)) catSelect.value = currentCat;
        handleCategoryChange();
    }

    function handleCategoryChange() {
        const catSelect = document.getElementById('category');
        const customCatDiv = document.getElementById('customCategoryContainer');
        
        if(catSelect.value === 'Otro') {
            customCatDiv.style.display = 'block';
            document.getElementById('customCategoryInput').required = true;
            document.getElementById('conceptSelect').innerHTML = '<option value="Otro">Otro</option>'; 
            handleConceptChange();
        } else {
            customCatDiv.style.display = 'none';
            document.getElementById('customCategoryInput').required = false;
            updateConceptLogic();
        }
    }

    function updateConceptLogic() {
        const cat = document.getElementById('category').value;
        const conceptSelect = document.getElementById('conceptSelect');
        const currentConcept = conceptSelect.value;
        conceptSelect.innerHTML = '';

        if(cat === 'Otro') return;

        let concepts = appData.concepts[cat] || [];
        concepts = [...concepts].sort();
        concepts.push("Otro");

        concepts.forEach(c => {
            const el = document.createElement('option');
            el.value = c; el.innerText = c;
            conceptSelect.appendChild(el);
        });

        if(concepts.includes(currentConcept)) conceptSelect.value = currentConcept;
        handleConceptChange();
    }

    function handleConceptChange() {
        const val = document.getElementById('conceptSelect').value;
        const customDiv = document.getElementById('customConceptContainer');
        if(val === 'Otro') {
            customDiv.style.display = 'block';
            document.getElementById('customConceptInput').required = true;
        } else {
            customDiv.style.display = 'none';
            document.getElementById('customConceptInput').required = false;
        }
    }

    // --- 5. GESTIÃ“N LISTAS ---
    function deleteCurrentCategory() {
        const type = document.getElementById('type').value;
        const cat = document.getElementById('category').value;
        if(cat === 'Otro') return alert("No puedes eliminar 'Otro'.");
        if(confirm(`Â¿Eliminar categorÃ­a "${cat}" y sus conceptos?`)) {
            if(type === 'income') appData.categories.income = appData.categories.income.filter(c => c !== cat);
            else appData.categories.expense = appData.categories.expense.filter(c => c !== cat);
            delete appData.concepts[cat];
            saveAppData(); updateCategoryLogic();
        }
    }

    function deleteCurrentConcept() {
        const cat = document.getElementById('category').value;
        const concept = document.getElementById('conceptSelect').value;
        if(concept === 'Otro' || cat === 'Otro') return alert("No puedes eliminar 'Otro'.");
        if(confirm(`Â¿Eliminar concepto "${concept}"?`)) {
            if(appData.concepts[cat]) {
                appData.concepts[cat] = appData.concepts[cat].filter(c => c !== concept);
                saveAppData(); updateConceptLogic();
            }
        }
    }
    function saveAppData() { localStorage.setItem('appData_v8', JSON.stringify(appData)); }

    // --- 6. REGISTRAR ---
    document.getElementById('form').addEventListener('submit', function(e) {
        e.preventDefault();
        const type = document.getElementById('type').value;
        const amount = document.getElementById('amount').value;
        const rawDate = document.getElementById('date').value;

        let finalCat = document.getElementById('category').value;
        if(finalCat === 'Otro') {
            finalCat = document.getElementById('customCategoryInput').value.trim();
            if(!finalCat) return alert("Nombre categorÃ­a requerido");
            if(type === 'income') { if(!appData.categories.income.includes(finalCat)) appData.categories.income.push(finalCat); }
            else { if(!appData.categories.expense.includes(finalCat)) appData.categories.expense.push(finalCat); }
            if(!appData.concepts[finalCat]) appData.concepts[finalCat] = [];
        }

        let finalConcept = document.getElementById('conceptSelect').value;
        if(finalConcept === 'Otro') {
            finalConcept = document.getElementById('customConceptInput').value.trim();
            if(!finalConcept) return alert("Nombre concepto requerido");
            if(!appData.concepts[finalCat].includes(finalConcept)) appData.concepts[finalCat].push(finalConcept);
        }

        saveAppData();

        const monthKey = rawDate.substring(0, 7);
        const transaction = {
            id: editingId ? editingId : Date.now(),
            date: rawDate,
            monthKey: monthKey,
            text: finalConcept,
            category: finalCat,
            amount: type === 'expense' ? -Math.abs(amount) : Math.abs(amount),
            executed: document.getElementById('executed').checked
        };

        if(editingId) {
            const index = transactions.findIndex(t => t.id === editingId);
            if(index !== -1) transactions[index] = transaction;
            cancelEdit();
        } else {
            transactions.push(transaction);
        }

        updateLocalStorage();
        if(document.getElementById('currentMonth').value !== monthKey) document.getElementById('currentMonth').value = monthKey;
        
        document.getElementById('customCategoryInput').value = '';
        document.getElementById('customConceptInput').value = '';
        updateCategoryLogic(); loadData();
        
        if(!editingId) { document.getElementById('amount').value = ''; document.getElementById('amount').focus(); }
    });

    // --- 7. RENDER ---
    function loadData() {
        updateMonthLabel(); 
        
        const selectedMonth = document.getElementById('currentMonth').value;
        const dollarRate = +document.getElementById('manualDolar').value || 1200;
        
        let monthTrans = transactions.filter(t => t.monthKey === selectedMonth || (t.date && t.date.startsWith(selectedMonth)));
        monthTrans.sort((a,b) => new Date(a.date) - new Date(b.date));

        if(isAccountingView) renderAccountingView(monthTrans);
        else renderListView(monthTrans);

        updateValues(monthTrans, dollarRate);
        updateChart(monthTrans);
    }

    function renderListView(data) {
        const list = document.getElementById('list');
        list.innerHTML = '';
        const today = new Date();
        today.setHours(0,0,0,0);

        data.forEach(t => {
            const row = document.createElement('tr');
            const tDate = new Date(t.date + 'T00:00:00');
            const isAlert = Math.ceil((tDate - today) / (1000 * 60 * 60 * 24)) <= 5;
            const isExec = t.executed !== false;
            
            let catClass = 'gray';
            if(t.category === 'Esenciales') catClass = 'efectivo';
            else if(t.category === 'Deudas') catClass = 'banco';
            else if(t.category === 'Ahorro') catClass = 'green';

            row.innerHTML = `
                <td style="text-align:center;"><i class="fas ${isExec ? 'fa-check-circle status-executed' : 'fa-clock status-pending'} status-icon" onclick="toggleStatus(${t.id})"></i></td>
                <td class="${isAlert ? 'date-alert' : ''}">${t.date}</td>
                <td><span class="tag ${catClass}">${t.category}</span></td>
                <td style="color:var(--text-1); font-weight:500;">${t.text}</td>
                <td style="text-align:right;" class="${t.amount < 0 ? 'amount-neg' : 'amount-pos'}">${t.amount < 0 ? '-' : ''}$${Math.abs(t.amount).toLocaleString()}</td>
                <td style="text-align:center;">
                    <button class="action-btn btn-edit" onclick="startEdit(${t.id})"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn btn-del" onclick="removeTransaction(${t.id})"><i class="fas fa-trash"></i></button>
                </td>
            `;
            list.appendChild(row);
        });
    }

    function renderAccountingView(data) {
        const listInc = document.getElementById('acc-list-inc');
        const listExp = document.getElementById('acc-list-exp');
        listInc.innerHTML = ''; listExp.innerHTML = '';
        let totalInc = 0; let totalExp = 0;

        data.forEach(t => {
            const li = document.createElement('li');
            li.className = 'acc-item';
            const statusIcon = t.executed !== false ? '<i class="fas fa-check" style="color:var(--success)"></i>' : '<i class="fas fa-clock" style="color:var(--text-3)"></i>';
            const day = t.date.split('-')[2];

            li.innerHTML = `
                <span>${statusIcon} <span style="color:var(--text-1); font-weight:500;">${t.text}</span> <small style="color:var(--text-3)">(${day})</small></span>
                <span style="font-weight:600; color:var(--text-2);">$${Math.abs(t.amount).toLocaleString()}</span>
            `;

            if(t.amount >= 0) { listInc.appendChild(li); totalInc += t.amount; }
            else { listExp.appendChild(li); totalExp += Math.abs(t.amount); }
        });
        document.getElementById('acc-total-inc').innerText = `$${totalInc.toLocaleString()}`;
        document.getElementById('acc-total-exp').innerText = `$${totalExp.toLocaleString()}`;
    }

    // --- CHART ---
    let myChart = null;

    function resetChartLevel() { chartLevel = 'category'; chartFilterCategory = null; loadData(); }

    function updateChart(data) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        const totalIncome = data.filter(t => t.amount > 0).reduce((acc, t) => acc + t.amount, 0);
        const expenses = data.filter(t => t.amount < 0);
        
        let labels = [], values = [], colors = [];

        if (totalIncome === 0 && expenses.length === 0) {
            labels = ["VacÃ­o"]; values = [1]; colors = ["#F1F5F9"];
        } else {
            let aggregated = {};
            let totalExpenses = 0;

            if (chartLevel === 'category') {
                document.getElementById('chart-title').innerText = "DistribuciÃ³n (Base: Ingresos)";
                document.getElementById('chart-reset-btn').style.display = 'none';
                expenses.forEach(t => { aggregated[t.category] = (aggregated[t.category] || 0) + Math.abs(t.amount); totalExpenses += Math.abs(t.amount); });
            } else {
                document.getElementById('chart-title').innerText = "Detalle: " + chartFilterCategory;
                document.getElementById('chart-reset-btn').style.display = 'block';
                expenses.filter(t => t.category === chartFilterCategory).forEach(t => { aggregated[t.text] = (aggregated[t.text] || 0) + Math.abs(t.amount); totalExpenses += Math.abs(t.amount); });
            }

            labels = Object.keys(aggregated);
            values = Object.values(aggregated);
            
            if (chartLevel === 'category') {
                const balance = totalIncome - totalExpenses;
                if (balance > 0) { labels.push("Balance (No Asignado)"); values.push(balance); }
            }
            const palette = ['#EF4444', '#3B82F6', '#F59E0B', '#8B5CF6', '#10B981', '#F97316', '#06B6D4'];
            colors = labels.map((l, i) => l.includes("Balance") ? "#CBD5E1" : palette[i % palette.length]);
        }

        if(myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    tooltip: { 
                        backgroundColor: '#0B1220',
                        padding: 12,
                        callbacks: { label: function(ctx) { let val = ctx.parsed; let pct = totalIncome > 0 ? ((val / totalIncome) * 100).toFixed(1) + '%' : 'N/A'; return ` ${ctx.label}: $${val.toLocaleString()} (${pct})`; } } 
                    },
                    legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8, font: { family: 'Inter', size: 11 } } }
                },
                onClick: (evt, elements) => {
                    if(elements.length > 0 && chartLevel === 'category') {
                        const idx = elements[0].index;
                        const label = labels[idx];
                        if(!label.includes("Balance")) { chartLevel = 'concept'; chartFilterCategory = label; loadData(); }
                    }
                }
            }
        });
    }

    // --- UTILS ---
    function toggleViewMode() {
        isAccountingView = !isAccountingView;
        const btn = document.getElementById('viewToggleBtn');
        document.getElementById('view-list').style.display = isAccountingView ? 'none' : 'block';
        document.getElementById('view-accounting').style.display = isAccountingView ? 'flex' : 'none';
        btn.innerHTML = isAccountingView ? '<i class="fas fa-list"></i> Lista' : '<i class="fas fa-exchange-alt"></i> Cuenta T';
        loadData();
    }
    
    window.toggleStatus = function(id) { const idx = transactions.findIndex(t => t.id === id); if(idx !== -1) { transactions[idx].executed = !transactions[idx].executed; updateLocalStorage(); loadData(); } }

    window.startEdit = function(id) {
        if(isAccountingView) { if(confirm("Â¿Cambiar a vista lista para editar?")) toggleViewMode(); return; }
        const t = transactions.find(t => t.id === id); if(!t) return;
        editingId = id;
        document.getElementById('date').value = t.date;
        document.getElementById('executed').checked = t.executed !== false;
        document.getElementById('type').value = t.amount >= 0 ? 'income' : 'expense';
        document.getElementById('amount').value = Math.abs(t.amount);
        updateCategoryLogic();
        document.getElementById('category').value = t.category;
        
        if(!document.getElementById('category').value) {
             const opt = document.createElement('option'); opt.value = t.category; opt.innerText = t.category;
             document.getElementById('category').add(opt, 0); document.getElementById('category').value = t.category;
        }

        handleCategoryChange();
        document.getElementById('conceptSelect').value = t.text;
        
        if(!document.getElementById('conceptSelect').value) {
             const opt = document.createElement('option'); opt.value = t.text; opt.innerText = t.text;
             document.getElementById('conceptSelect').add(opt, 0); document.getElementById('conceptSelect').value = t.text;
        }

        document.getElementById('btn-submit').innerText = "Guardar Cambios";
        document.getElementById('btn-submit').classList.add('editing');
        document.getElementById('btn-cancel').style.display = 'block';
        document.querySelector('.sidebar').scrollTop = 0;
    }

    window.cancelEdit = function() { editingId = null; document.getElementById('form').reset(); document.getElementById('btn-submit').innerText = "Registrar Movimiento"; document.getElementById('btn-submit').classList.remove('editing'); document.getElementById('btn-cancel').style.display = 'none'; updateCategoryLogic(); }
    
    function updateValues(data, dollarRate) { const total = data.reduce((acc, t) => acc + t.amount, 0); document.getElementById('month-balance').innerText = `$${total.toLocaleString()}`; document.getElementById('usd-savings').innerText = `US$ ${(total > 0 ? total / dollarRate : 0).toFixed(2)}`; }
    function updateDolarImpact() { localStorage.setItem('savedDolarRate', document.getElementById('manualDolar').value); loadData(); }
    function updateLocalStorage() { localStorage.setItem('transactions_v4', JSON.stringify(transactions)); }
    window.downloadData = function() { const exportData = { transactions: transactions, appData: appData }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData)); const a = document.createElement('a'); a.href = dataStr; a.download = "finanzas_full_backup.json"; a.click(); }
    window.importData = function(input) { const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { try { const imported = JSON.parse(e.target.result); if(imported.transactions) { transactions = imported.transactions; appData = imported.appData || defaultData; } else { transactions = imported; } updateLocalStorage(); saveAppData(); loadData(); updateCategoryLogic(); alert('Datos cargados'); } catch(err) { alert('Error archivo'); } }; reader.readAsText(file); }
    window.cloneMonthData = function() { const src = document.getElementById('cloneSourceMonth').value; const tgt = document.getElementById('currentMonth').value; if(!src || src===tgt) return alert("Mes invÃ¡lido"); const srcTrans = transactions.filter(t => t.monthKey === src); if(!srcTrans.length || !confirm(`Copiar ${srcTrans.length} items?`)) return; srcTrans.forEach(t => transactions.push({...t, id: Date.now()+Math.random(), date: `${tgt}-${t.date.split('-')[2]}`, monthKey: tgt, executed: false})); updateLocalStorage(); loadData(); }
    window.removeTransaction = function(id) { if(confirm('Â¿Eliminar?')) { transactions = transactions.filter(t => t.id !== id); if(editingId===id) cancelEdit(); updateLocalStorage(); loadData(); } }
</script>
</body>
</html>
