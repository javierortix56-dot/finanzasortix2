<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>J&M Mobile Cloud V36.2</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='128' fill='%2310B981'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='central' text-anchor='middle' font-family='sans-serif' font-weight='800' font-size='320' fill='white'%3E$%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-app: #F8FAFC; --surface: #FFFFFF;
            --text-dark: #0F172A; --text-gray: #64748B;
            --inc-color: #10B981; --inc-bg: #ECFDF5;
            --exp-color: #EF4444; --exp-bg: #FEF2F2;
            --primary: #2563EB; --border: #E2E8F0;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-app); margin: 0; color: var(--text-dark); padding-bottom: 100px; }

        /* --- HEADER --- */
        .top-bar { background: var(--surface); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .brand { font-weight: 900; color: var(--primary); font-size: 18px; display: flex; flex-direction: column; line-height: 1; }
        .sync-badge { font-size: 9px; font-weight: 700; background: #FEF3C7; color: #B45309; padding: 2px 6px; border-radius: 4px; margin-top: 2px; text-transform: uppercase; width: fit-content; }
        .sync-badge.ok { background: #DCFCE7; color: #166534; }
        .sync-badge.error { background: #FEE2E2; color: #991B1B; }

        /* --- NAVEGACIÓN (FIX) --- */
        .date-ctrl { 
            display: flex; align-items: center; background: #F1F5F9; border-radius: 8px; 
            padding: 2px; border: 1px solid var(--border); position: relative;
        }
        .btn-arrow { 
            background: transparent; border: none; width: 45px; height: 35px; 
            cursor: pointer; color: var(--text-dark); font-size: 18px; 
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .date-display { 
            font-size: 12px; font-weight: 700; text-transform: uppercase; 
            min-width: 100px; text-align: center; position: relative;
        }
        #dateInput {
            position: absolute; top: 0; left: 45px; width: 100px; height: 100%;
            opacity: 0; cursor: pointer; z-index: 5;
        }

        /* --- KPI BALANCE --- */
        .kpi-wrapper { padding: 15px 15px 5px 15px; }
        .kpi-card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); text-align: center; container-type: inline-size; }
        .kpi-val { font-size: clamp(24px, 12cqw, 34px); font-weight: 800; letter-spacing: -1px; line-height: 1.1; overflow-wrap: break-word; transition: 0.3s; }
        
        .copy-zone { padding: 15px; margin: 0 15px 10px 15px; display: none; background: white; border-radius: 12px; border: 1px dashed var(--border); }
        .copy-controls { display: flex; gap: 8px; margin-top: 8px; }
        .btn-copy-month { flex: 1; background: var(--text-dark); color: white; border: none; padding: 0 12px; border-radius: 8px; font-weight: 700; font-size: 13px; height: 40px; }

        /* --- LISTAS --- */
        .t-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .t-col { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .col-header { padding: 8px; text-align: center; font-size: 11px; font-weight: 800; text-transform: uppercase; color: white; }
        .bg-inc { background: var(--inc-color); } .bg-exp { background: var(--exp-color); }
        .col-total { display: block; background: rgba(0,0,0,0.1); margin-top: 2px; border-radius: 4px; padding: 2px; }
        .row-item { background: white; padding: 12px 8px; border-bottom: 1px solid #F1F5F9; }

        /* --- GRÁFICO (RESTAURADO) --- */
        .section-header { padding: 0 20px; margin-top: 25px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .sec-title { font-size: 14px; font-weight: 800; color: var(--text-dark); }
        .btn-reset-chart { font-size: 11px; color: var(--primary); font-weight: 700; border: none; background: none; cursor: pointer; display: none; }
        .chart-box { background: var(--surface); margin: 0 15px; padding: 15px; border-radius: 16px; border: 1px solid var(--border); height: 320px; position: relative; }

        /* --- BOTONES ACCIÓN --- */
        .action-btns { padding: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-big { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: white; color: var(--text-dark); font-weight: 700; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; min-width: 45%; }
        .btn-sync { width: 100%; margin-top: 5px; background: var(--primary); color: white; border: none; }

        /* --- FORMULARIO --- */
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--text-dark); color: white; border-radius: 50%; border:none; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 24px; z-index: 40; }
        .sheet { position: fixed; bottom: 0; width: 100%; background: white; z-index: 100; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: 0.3s; padding: 25px 20px; max-height: 90vh; overflow-y: auto; }
        .sheet.open { transform: translateY(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; backdrop-filter: blur(3px); }
        
        /* Switch Grande con Iconos */
        .sw-container { display: flex; background: #F1F5F9; padding: 5px; border-radius: 12px; margin-bottom: 20px; gap: 5px; }
        .sw-item { 
            flex: 1; padding: 15px; text-align: center; font-size: 14px; font-weight: 700; 
            border-radius: 10px; cursor: pointer; color: var(--text-gray); 
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            transition: 0.2s;
        }
        .sw-item i { font-size: 18px; }
        .sw-item.active.exp { background: var(--exp-color); color: white; }
        .sw-item.active.inc { background: var(--inc-color); color: white; }

        .inp { width: 100%; height: 48px; border: 1px solid var(--border); border-radius: 10px; padding: 0 12px; background: #F8FAFC; margin-bottom: 12px; font-size: 16px; font-family: 'Inter'; }
        .lbl { font-size: 11px; font-weight: 800; color: var(--text-gray); text-transform: uppercase; margin-bottom: 5px; display: block; }
        .btn-save { width: 100%; height: 55px; background: var(--text-dark); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 16px; margin-top: 10px; }

        .loader-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:200; display:none; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { width:40px; height:40px; border:4px solid #E2E8F0; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
        .c-inc { color: var(--inc-color); font-weight: 800; } .c-exp { color: var(--exp-color); font-weight: 800; }
    </style>
</head>
<body>

<div id="loader" class="loader-overlay"><div class="spinner"></div></div>
<div class="overlay" id="overlay" onclick="closeSheet()"></div>

<header class="top-bar">
    <div class="brand">J&M <div id="syncBadge" class="sync-badge">Cargando...</div></div>
    <div class="date-ctrl">
        <button class="btn-arrow" type="button" onclick="navMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="date-display"><span id="monthTxt">...</span><input type="month" id="dateInput" onchange="loadData()"></div>
        <button class="btn-arrow" type="button" onclick="navMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</header>

<div class="kpi-wrapper">
    <div class="kpi-card">
        <div class="kpi-label">Balance Neto</div>
        <div id="kpiBal" class="kpi-val">$0</div>
        <div style="margin-top: 10px; font-size: 13px; color: var(--text-gray); display: flex; justify-content: center; gap: 15px;">
            <span>USD <span id="kpiUsd" style="font-weight:800; color: var(--text-dark);">0.00</span></span>
            <span>TC: <input type="number" id="usdRate" value="1200" style="width:55px; border:none; background:#F1F5F9; font-weight:700; text-align:right;" onchange="loadData()"></span>
        </div>
    </div>
</div>

<div class="copy-zone" id="copyZone">
    <div style="font-size:12px; color:var(--text-gray); font-weight:700;">Mes vacío. Importar movimientos de:</div>
    <div class="copy-controls">
        <input type="month" id="copySourcePicker" class="inp" style="height:40px; margin:0;">
        <button class="btn-copy-month" onclick="copyFromSelected()">COPIAR</button>
    </div>
</div>

<div class="t-grid">
    <div class="t-col"><div class="col-header bg-inc">Ingresos<br><span id="sum-inc" class="col-total">$0</span></div><div class="t-list" id="list-inc"></div></div>
    <div class="t-col"><div class="col-header bg-exp">Egresos<br><span id="sum-exp" class="col-total">$0</span></div><div class="t-list" id="list-exp"></div></div>
</div>

<div class="section-header">
    <span class="sec-title">Distribución</span>
    <button id="chartReset" class="btn-reset-chart" onclick="resetChart()">
        <i class="fas fa-arrow-left"></i> VOLVER
    </button>
</div>
<div class="chart-box">
    <canvas id="myChart"></canvas>
    <div id="chartCenterText" style="position:absolute; top:40%; left:50%; transform:translate(-50%, -50%); font-size:10px; color:#64748B; pointer-events:none; font-weight:600; text-align:center;">Toca para<br>detalle</div>
</div>

<div class="action-btns">
    <button class="btn-big" onclick="backup()"><i class="fas fa-download"></i> Backup Local</button>
    <button class="btn-big" onclick="document.getElementById('fileIn').click()"><i class="fas fa-upload"></i> Restaurar</button>
    <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
    <button class="btn-big btn-sync" onclick="forceSync()"><i class="fas fa-sync"></i> Sincronizar Nube</button>
</div>

<button class="fab" onclick="openSheet()"><i class="fas fa-plus"></i></button>

<div class="sheet" id="sheet">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <span style="font-size:18px; font-weight:800;" id="formTitle">Nuevo</span>
        <span onclick="closeSheet()" style="font-size:20px; color:#94A3B8;"><i class="fas fa-times"></i></span>
    </div>

    <form id="txForm">
        <div class="sw-container">
            <div class="sw-item" id="sw-exp" onclick="setType('exp')"><i class="fas fa-minus-circle"></i> Gasto</div>
            <div class="sw-item" id="sw-inc" onclick="setType('inc')"><i class="fas fa-plus-circle"></i> Ingreso</div>
        </div>
        <input type="hidden" id="fType" value="exp">

        <label class="lbl">Monto</label>
        <input type="number" id="fAmount" class="inp" placeholder="0.00" step="0.01" required>
        
        <label class="lbl">Fecha</label>
        <input type="date" id="fDate" class="inp" required>
        
        <label class="lbl">Categoría</label>
        <select id="fCat" class="inp" onchange="renderConcepts()" required></select>
        
        <label class="lbl">Concepto</label>
        <select id="fConcept" class="inp" onchange="checkNewConcept()" required></select>
        <input type="text" id="fConceptCustom" class="inp" style="margin-top:5px; display:none;" placeholder="Nombre...">
        
        <div style="margin:20px 0; display:flex; align-items:center; gap:10px;"><input type="checkbox" id="fExec" checked style="width:22px; height:22px;"> <label style="font-weight:700; font-size:14px;">Consolidado</label></div>
        
        <button type="submit" id="btnSave" class="btn-save">GUARDAR</button>
        <button type="button" id="btnDel" onclick="del(editId)" style="width:100%; color:red; border:none; background:none; margin-top:15px; font-weight:800; display:none;">ELIMINAR</button>
    </form>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
    let data = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Ventas','Varios'] }, concepts: {} };
    let editId = null, chartInstance = null, currentTxs = [];

    window.onload = () => {
        const d = new Date();
        document.getElementById('dateInput').value = d.toISOString().slice(0, 7);
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        if(localStorage.getItem('usdRate')) document.getElementById('usdRate').value = localStorage.getItem('usdRate');
        forceSync();
    };

    async function forceSync() {
        showLoad(true);
        try {
            const res = await fetch(API_URL);
            const cloudData = await res.json();
            if(cloudData && cloudData.txs) { data = cloudData; loadData(); status("EN LÍNEA", "ok"); }
        } catch(e) { status("ERROR NUBE", "error"); }
        showLoad(false);
    }

    async function saveData() {
        showLoad(true);
        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
            status("GUARDADO", "ok"); loadData();
        } catch(e) { status("ERROR NUBE", "error"); }
        showLoad(false);
    }

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('monthTxt').innerText = `${months[parseInt(m)-1]} ${y}`;
        currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym)).sort((a,b) => a.date.localeCompare(b.date));
        document.getElementById('copyZone').style.display = currentTxs.length === 0 ? 'block' : 'none';
        renderLists(currentTxs); resetChart(); renderCats();
    }

    function renderLists(txs) {
        const lInc = document.getElementById('list-inc'), lExp = document.getElementById('list-exp');
        lInc.innerHTML = ''; lExp.innerHTML = '';
        let tInc=0, tExp=0;
        txs.forEach(t => {
            const isInc = t.type === 'inc'; const amt = Math.abs(t.amount);
            if(isInc) tInc += amt; else tExp += amt;
            const div = document.createElement('div');
            div.className = 'row-item'; div.style.opacity = !t.exec ? '0.6' : '1';
            div.onclick = () => edit(t.id);
            div.innerHTML = `<div style="font-weight:800;font-size:13px">${t.desc}</div><div style="font-size:10px;color:gray;font-weight:700;">${t.cat} | DÍA ${t.date.split('-')[2]} | <span class="${isInc?'c-inc':'c-exp'}">$${Math.floor(amt).toLocaleString()}</span></div>`;
            (isInc ? lInc : lExp).appendChild(div);
        });
        document.getElementById('sum-inc').innerText = `$${tInc.toLocaleString()}`;
        document.getElementById('sum-exp').innerText = `$${tExp.toLocaleString()}`;
        const bal = tInc - tExp;
        const balEl = document.getElementById('kpiBal');
        balEl.innerText = `$${bal.toLocaleString()}`;
        balEl.style.color = bal >= 0 ? '#10B981' : '#EF4444';
        const rate = parseFloat(document.getElementById('usdRate').value) || 1;
        document.getElementById('kpiUsd').innerText = (bal/rate).toFixed(2);
    }

    function renderChart(txs, filterCat) {
        const ctx = document.getElementById('myChart'); if(chartInstance) chartInstance.destroy();
        const btnReset = document.getElementById('chartReset'); const centerTxt = document.getElementById('chartCenterText');
        let exps = txs.filter(t => t.type === 'exp');
        let map = !filterCat ? exps.reduce((a,t)=>{ a[t.cat]=(a[t.cat]||0)+t.amount; return a; }, {}) : exps.filter(t => t.cat === filterCat).reduce((a,t)=>{ a[t.desc]=(a[t.desc]||0)+t.amount; return a; }, {});
        btnReset.style.display = filterCat ? 'block' : 'none'; centerTxt.innerText = filterCat || "Toca para detalle";
        chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(map), datasets: [{ data: Object.values(map), backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1'], borderWidth: 2, borderColor: '#ffffff' }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }, onClick: (e, el) => { if (el.length > 0 && !filterCat) renderChart(txs, Object.keys(map)[el[0].index]); } } });
    }

    function setType(t) { document.getElementById('fType').value = t; document.getElementById('sw-inc').className = `sw-item ${t=='inc'?'active inc':''}`; document.getElementById('sw-exp').className = `sw-item ${t=='exp'?'active exp':''}`; renderCats(); }
    function renderCats() { const t = document.getElementById('fType').value, s = document.getElementById('fCat'); s.innerHTML=''; (data.cats[t]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Crear...','new')); renderConcepts(); }
    function renderConcepts() { const cVal = document.getElementById('fCat').value; if(cVal==='new'){ const n=prompt('Nueva Categoría:'); if(n){ data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; saveData(); renderCats(); document.getElementById('fCat').value=n; } else { renderCats(); return; } } const s = document.getElementById('fConcept'); s.innerHTML=''; (data.concepts[cVal]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Nuevo...','new_c')); checkNewConcept(); }
    function checkNewConcept() { const isNew = document.getElementById('fConcept').value==='new_c'; document.getElementById('fConceptCustom').style.display=isNew?'block':'none'; }
    function openSheet() { if(!editId) resetForm(); document.getElementById('sheet').classList.add('open'); document.getElementById('overlay').style.display='block'; }
    function closeSheet() { document.getElementById('sheet').classList.remove('open'); document.getElementById('overlay').style.display='none'; }
    function resetForm() { editId=null; document.getElementById('txForm').reset(); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('btnDel').style.display='none'; setType('exp'); }
    function navMonth(n) { const i = document.getElementById('dateInput'); let [y,m]=i.value.split('-'); const d = new Date(y, m-1+n, 1); i.value = d.toISOString().slice(0,7); loadData(); }
    function resetChart() { renderChart(currentTxs, null); }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value, desc = document.getElementById('fConcept').value;
        if(desc==='new_c') { desc=document.getElementById('fConceptCustom').value; if(!data.concepts[cat]) data.concepts[cat]=[]; data.concepts[cat].push(desc); }
        const tx = { id:editId||Date.now(), date:document.getElementById('fDate').value, amount:parseFloat(document.getElementById('fAmount').value), type:document.getElementById('fType').value, cat, desc, exec:document.getElementById('fExec').checked };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); data.txs[i]=tx; } else { if(!data.txs) data.txs=[]; data.txs.push(tx); }
        saveData(); closeSheet();
    }

    function edit(id) {
        const t = data.txs.find(x=>x.id==id); editId=id; document.getElementById('fDate').value=t.date; document.getElementById('fAmount').value=Math.abs(t.amount); document.getElementById('fExec').checked=t.exec;
        setType(t.type); document.getElementById('fCat').value=t.cat; renderConcepts(); document.getElementById('fConcept').value=t.desc;
        document.getElementById('btnDel').style.display='block'; openSheet();
    }
    function del(id) { if(confirm('¿Borrar?')) { data.txs=data.txs.filter(x=>x.id!=id); saveData(); closeSheet(); } }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download=`Finanzas_JM.json`; a.click(); }
    function restoreSmart(i) { const r=new FileReader(); r.onload=e=>{ data=JSON.parse(e.target.result); saveData(); }; r.readAsText(i.files[0]); }
    function showLoad(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function status(t, c) { const b = document.getElementById('syncBadge'); b.innerText = t; b.className = `sync-badge ${c}`; }
</script>
</body>
</html>
